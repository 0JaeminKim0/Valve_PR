<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°¸ë¸Œì¬ êµ¬ë§¤ AI Agent PoC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Noto Sans KR', sans-serif; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .slide-in { animation: slideIn 0.4s ease-out forwards; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .pulse { animation: pulse 1.5s ease-in-out infinite; }
        
        .spinner {
            border: 2px solid rgba(255,255,255,0.1);
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        /* ì½˜ì†” ìŠ¤íƒ€ì¼ - Python ì›ë³¸ê³¼ ë™ì¼ */
        .console-output {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.7;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .console-header { color: #fbbf24; font-weight: bold; }
        .console-subheader { color: #60a5fa; }
        .console-success { color: #34d399; }
        .console-warning { color: #f59e0b; }
        .console-error { color: #f87171; }
        .console-info { color: #94a3b8; }
        .console-highlight { color: #a78bfa; }
        
        /* PRD í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .prd-table {
            font-size: 11px;
            border-collapse: collapse;
            width: 100%;
        }
        .prd-table th {
            background: #1e293b;
            color: #e2e8f0;
            font-weight: 600;
            padding: 10px 6px;
            text-align: center;
            border: 1px solid #334155;
            white-space: nowrap;
        }
        .prd-table th.section-header {
            background: #0f172a;
            color: #60a5fa;
            font-size: 12px;
            font-weight: 700;
        }
        .prd-table th.sub-section {
            background: #1e3a5f;
            color: #93c5fd;
        }
        .prd-table td {
            padding: 8px 6px;
            border: 1px solid #334155;
            text-align: center;
            vertical-align: middle;
        }
        .prd-table tr:nth-child(even) td { background: rgba(30,41,59,0.3); }
        .prd-table tr:hover td { background: rgba(59, 130, 246, 0.15); }
        .prd-table .text-left { text-align: left; }
        .prd-table .text-right { text-align: right; }
        .prd-table .highlight { background: rgba(251, 191, 36, 0.15) !important; }
        .prd-table .price { font-family: 'Consolas', monospace; font-weight: 500; }
        .prd-table .mapped { color: #34d399; }
        .prd-table .unmapped { color: #f59e0b; }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800/80 backdrop-blur border-b border-gray-700/50 px-6 py-4 sticky top-0 z-50">
        <div class="flex items-center justify-between max-w-[1920px] mx-auto">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold">ë°¸ë¸Œì¬ êµ¬ë§¤ AI Agent PoC</h1>
                    <p class="text-gray-400 text-xs">PR ìµœì ë‹¨ê°€ ì œì•ˆ Â· ê²¬ì  ê²€ì¦ Â· ì‹œí™© ë¶„ì„ (Python ê¸°ë°˜)</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span id="apiStatus" class="px-3 py-1.5 bg-yellow-500/20 text-yellow-400 rounded-full text-xs font-medium">
                    <i class="fas fa-circle text-[8px] mr-1.5 pulse"></i>ì—°ê²° í™•ì¸ ì¤‘...
                </span>
                <span class="text-gray-400 text-xs">
                    <i class="fas fa-database mr-1"></i><span id="dataCount">ë¡œë”©...</span>
                </span>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="bg-gray-800/40 px-6 py-3 border-b border-gray-700/50">
        <div class="flex gap-2 max-w-[1920px] mx-auto">
            <button onclick="switchTab(1)" class="tab-btn active px-5 py-2 rounded-lg text-sm font-medium transition-all" data-tab="1">
                <i class="fas fa-calculator mr-2"></i>í™”ë©´1: PR ìµœì ë‹¨ê°€ ì œì•ˆ
            </button>
            <button onclick="switchTab(2)" class="tab-btn px-5 py-2 rounded-lg text-sm font-medium transition-all bg-gray-700/50 hover:bg-gray-700" data-tab="2">
                <i class="fas fa-check-circle mr-2"></i>í™”ë©´2: í˜‘ë ¥ì‚¬ ê²¬ì  ê²€ì¦
            </button>
            <button onclick="switchTab(3)" class="tab-btn px-5 py-2 rounded-lg text-sm font-medium transition-all bg-gray-700/50 hover:bg-gray-700" data-tab="3">
                <i class="fas fa-chart-line mr-2"></i>í™”ë©´3: ì‹œí™© ë¶„ì„
            </button>
        </div>
    </nav>

    <!-- Main Content: 35% Agent Log + 65% Results -->
    <main class="flex h-[calc(100vh-130px)] max-w-[1920px] mx-auto">
        <!-- Left Panel: Agent Logs (35%) -->
        <div class="w-[35%] border-r border-gray-700/50 flex flex-col bg-gray-900/50">
            <div class="p-4 border-b border-gray-700/50 bg-gray-800/30">
                <div class="flex items-center justify-between">
                    <h2 class="font-semibold text-sm flex items-center gap-2">
                        <i class="fas fa-terminal text-blue-400"></i>
                        Agent ë¶„ì„ ë¡œê·¸ (Python ìŠ¤íƒ€ì¼)
                    </h2>
                    <div class="flex items-center gap-2">
                        <button onclick="runCurrentAnalysis()" id="runBtn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-xs font-medium transition-all">
                            <i class="fas fa-play mr-1"></i>ë¶„ì„ ì‹¤í–‰
                        </button>
                        <button onclick="clearLogs()" class="text-gray-400 hover:text-white text-xs px-2 py-1">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div id="agentLogs" class="flex-1 overflow-y-auto p-4 console-output bg-gray-950/50">
                <div class="text-gray-500 text-center py-12">
                    <i class="fas fa-robot text-4xl mb-4 opacity-20"></i>
                    <p class="text-sm">"ë¶„ì„ ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´<br>Python ìŠ¤íƒ€ì¼ ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Results (65%) -->
        <div class="w-[65%] flex flex-col bg-gray-900/30">
            <!-- Tab 1: PR ìµœì ë‹¨ê°€ ì œì•ˆ -->
            <div id="tab1" class="tab-content flex-1 overflow-auto p-4">
                <div id="screen1-intro" class="text-center py-12 text-gray-500">
                    <i class="fas fa-file-invoice-dollar text-5xl mb-4 opacity-20"></i>
                    <p class="text-sm">PR ê±´ë³„ ìµœì  ë‹¨ê°€ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                    <p class="text-xs mt-2 text-gray-600">Rule1(BODY2) + Rule2(ì˜µì…˜) + Rule3(ìˆ˜ëŸ‰í™˜ì‚°) â†’ ê³„ì•½ë‹¨ê°€</p>
                    <p class="text-xs text-gray-600">ê³¼ê±° ë°œì£¼ì‹¤ì : 1ìˆœìœ„(íƒ€ì…+ë‚´ì—­) / 2ìˆœìœ„(íƒ€ì…ë§Œ)</p>
                </div>
                <div id="screen1-results" class="hidden"></div>
            </div>

            <!-- Tab 2: í˜‘ë ¥ì‚¬ ê²¬ì  ê²€ì¦ -->
            <div id="tab2" class="tab-content hidden flex-1 overflow-auto p-4">
                <div id="screen2-intro" class="text-center py-12 text-gray-500">
                    <i class="fas fa-clipboard-check text-5xl mb-4 opacity-20"></i>
                    <p class="text-sm">í˜‘ë ¥ì‚¬ ê²¬ì  ì ì •ì„± ê²€ì¦ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
                <div id="screen2-results" class="hidden"></div>
            </div>

            <!-- Tab 3: ì‹œí™© ë¶„ì„ -->
            <div id="tab3" class="tab-content hidden flex-1 overflow-auto p-4">
                <div id="screen3-intro" class="text-center py-12 text-gray-500">
                    <i class="fas fa-globe text-5xl mb-4 opacity-20"></i>
                    <p class="text-sm">ì›ì¬ë£Œ ì‹œí™© Ã— ë°œì£¼ë‹¨ê°€ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
                <div id="screen3-results" class="hidden"></div>
            </div>
        </div>
    </main>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Global State
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let currentTab = 1;
        let isRunning = false;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Utility Functions
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function fmt(n) {
            if (n === null || n === undefined || isNaN(n)) return '-';
            return Math.round(n).toLocaleString('ko-KR');
        }

        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Console Log Functions (Python ìŠ¤íƒ€ì¼)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const logContainer = () => document.getElementById('agentLogs');
        
        function clearLogs() {
            logContainer().innerHTML = `
                <div class="text-gray-500 text-center py-12">
                    <i class="fas fa-robot text-4xl mb-4 opacity-20"></i>
                    <p class="text-sm">"ë¶„ì„ ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´<br>Python ìŠ¤íƒ€ì¼ ë¡œê·¸ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
            `;
        }

        function initLogs() {
            logContainer().innerHTML = '';
        }

        async function renderLogs(logs) {
            for (const log of logs) {
                await renderSingleLog(log);
            }
        }

        async function renderSingleLog(log) {
            const container = logContainer();
            let html = '';
            
            switch (log.type) {
                case 'header':
                    const line = 'â•'.repeat(70);
                    html = `<div class="console-header">\n${line}\n  ${log.text}\n${line}</div>`;
                    break;
                    
                case 'subheader':
                    const subline = 'â”€'.repeat(60);
                    html = `<div class="console-subheader">\n  ${subline}\n  ğŸ“Œ ${log.text}\n  ${subline}</div>`;
                    break;
                    
                case 'info':
                    html = `<div class="console-info">${log.text}</div>`;
                    break;
                    
                case 'success':
                    html = `<div class="console-success">  âœ… ${log.text}</div>`;
                    break;
                    
                case 'warning':
                    html = `<div class="console-warning">  âš ï¸ ${log.text}</div>`;
                    break;
                    
                case 'highlight':
                    html = `<div class="console-highlight">  ${log.text}</div>`;
                    break;
                    
                case 'box':
                    const boxLines = log.lines.map(l => `  â”‚ ${l}`).join('\n');
                    const label = log.label ? ` ${log.label}` : '';
                    html = `<div class="console-info">
  â”Œâ”€â”€ PR #${log.seq}${label} ${'â”€'.repeat(50)}
${boxLines}
  â””${'â”€'.repeat(65)}</div>`;
                    break;
                    
                case 'agent':
                    const agentLabel = log.isApi ? 'ğŸ¤– [Claude API ì‘ë‹µ]' : 'ğŸ¤– [Rule-based ë¶„ì„]';
                    const agentLines = log.text.split('\n').map(l => `     ${l}`).join('\n');
                    html = `<div>
  <span class="console-highlight">${agentLabel}</span>
<span class="console-info">${agentLines}</span></div>`;
                    break;
                    
                default:
                    html = `<div class="console-info">${JSON.stringify(log)}</div>`;
            }
            
            const div = document.createElement('div');
            div.innerHTML = html;
            div.className = 'slide-in';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            await sleep(50);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Tab Switching
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function switchTab(tabNum) {
            currentTab = tabNum;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('bg-gray-700/50', 'hover:bg-gray-700');
            });
            const activeBtn = document.querySelector(`[data-tab="${tabNum}"]`);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('bg-gray-700/50', 'hover:bg-gray-700');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab${tabNum}`).classList.remove('hidden');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Run Analysis
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function runCurrentAnalysis() {
            if (isRunning) return;
            isRunning = true;
            
            const btn = document.getElementById('runBtn');
            btn.innerHTML = '<span class="spinner"></span> ë¶„ì„ ì¤‘...';
            btn.disabled = true;

            initLogs();

            try {
                if (currentTab === 1) {
                    await runScreen1Analysis();
                } else if (currentTab === 2) {
                    await runScreen2Analysis();
                } else if (currentTab === 3) {
                    await runScreen3Analysis();
                }
            } catch (err) {
                const container = logContainer();
                container.innerHTML += `<div class="console-error">âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message}</div>`;
            }

            btn.innerHTML = '<i class="fas fa-play mr-1"></i>ë¶„ì„ ì‹¤í–‰';
            btn.disabled = false;
            isRunning = false;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Screen 1: PR ê±´ ìµœì  ì¶”ì²œ ë‹¨ê°€ ì œì•ˆ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function runScreen1Analysis() {
            const res = await fetch('/api/screen1/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const data = await res.json();
            
            if (!data.success) throw new Error(data.error || 'ë¶„ì„ ì‹¤íŒ¨');
            
            // ë¡œê·¸ ë Œë”ë§
            await renderLogs(data.logs);
            
            // ê²°ê³¼ í…Œì´ë¸” ë Œë”ë§ (PRD í˜•ì‹)
            renderScreen1Results(data.results);
        }

        function renderScreen1Results(results) {
            document.getElementById('screen1-intro').classList.add('hidden');
            const container = document.getElementById('screen1-results');
            container.classList.remove('hidden');

            let html = `
            <div class="mb-4">
                <h3 class="text-base font-semibold flex items-center gap-2 mb-2">
                    <i class="fas fa-table text-blue-400"></i>
                    PR ê±´ë³„ ìµœì  ë‹¨ê°€ ì œì•ˆ ê²°ê³¼ (${results.length}ê±´) - PRD í…Œì´ë¸” í˜•ì‹
                </h3>
                <p class="text-xs text-gray-500">Rule1(BODY2) + Rule2(ì˜µì…˜) = ê³„ì•½ë‹¨ê°€ | ê³¼ê±°ë°œì£¼ 1ìˆœìœ„(íƒ€ì…+ë‚´ì—­) / 2ìˆœìœ„(íƒ€ì…)</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="prd-table">
                    <thead>
                        <!-- ëŒ€ë¶„ë¥˜ í—¤ë” -->
                        <tr>
                            <th class="section-header" colspan="5">PR ì„¸ë¶€ ë‚´ì—­</th>
                            <th class="section-header" colspan="4">ë‹¨ê°€í…Œì´ë¸” ë§¤í•‘ (Rule 1/2/3)</th>
                            <th class="section-header" colspan="5">ê³¼ê±° ë°œì£¼ ì‹¤ì  ê¸°ì¤€</th>
                            <th class="section-header" colspan="2">ì¶”ì²œ</th>
                        </tr>
                        <!-- ì†Œë¶„ë¥˜ í—¤ë” -->
                        <tr>
                            <th>No</th>
                            <th>ë°¸ë¸Œíƒ€ì…</th>
                            <th>ë§¤í•‘í‚¤</th>
                            <th style="min-width:180px">ìì¬ë‚´ì—­</th>
                            <th>ìˆ˜ëŸ‰</th>
                            <th>Rule1<br>BODY2</th>
                            <th>Rule2<br>ì˜µì…˜</th>
                            <th>Rule3<br>ê³„ì•½ë‹¨ê°€</th>
                            <th>ì˜µì…˜ìƒì„¸</th>
                            <th>ìˆœìœ„</th>
                            <th>ì—…ì²´ëª…</th>
                            <th>ë°œì£¼ì¼</th>
                            <th>ë°œì£¼ê¸ˆì•¡</th>
                            <th>Ã—90%</th>
                            <th>ì¶”ì²œë‹¨ê°€</th>
                            <th>ê·¼ê±°</th>
                        </tr>
                    </thead>
                    <tbody>`;

            for (const r of results) {
                const mappedClass = r.mapped ? 'mapped' : 'unmapped';
                const mappedIcon = r.mapped ? 'âœ“' : 'âœ—';
                
                const rank = r.recentOrder?.rank || '-';
                const rankShort = rank.includes('1ìˆœìœ„') 
                    ? '<span class="text-green-400 font-semibold">1ìˆœìœ„</span>' 
                    : (rank.includes('2ìˆœìœ„') ? '<span class="text-blue-400">2ìˆœìœ„</span>' : '-');
                
                const optionStr = r.rule2_optionDetails?.length 
                    ? `<span class="text-xs text-gray-400">${r.rule2_optionDetails.slice(0, 2).join('<br>')}</span>` 
                    : '-';

                html += `
                    <tr>
                        <td>${r.no}</td>
                        <td class="font-mono text-xs">${r.valveType || '-'}</td>
                        <td class="font-mono text-xs ${mappedClass}">${r.valveTypeBase || '-'} ${mappedIcon}</td>
                        <td class="text-left text-xs" style="max-width:180px">
                            <div class="truncate" title="${r.description || ''}">${r.description || '-'}</div>
                        </td>
                        <td>${r.quantity || '-'}${r.tableQty && r.tableQty !== 1 ? `<br><span class="text-xs text-gray-500">(í‘œ:${r.tableQty})</span>` : ''}</td>
                        <td class="text-right price ${r.mapped ? '' : 'text-gray-500'}">${fmt(r.rule1_body2)}</td>
                        <td class="text-right price">${fmt(r.rule2_option)}</td>
                        <td class="text-right price highlight font-semibold">${fmt(r.rule3_contractPrice)}</td>
                        <td>${optionStr}</td>
                        <td>${rankShort}</td>
                        <td class="text-xs">${r.recentOrder?.vendor?.substring(0, 6) || '-'}</td>
                        <td class="text-xs">${r.recentOrder?.date?.substring(5) || '-'}</td>
                        <td class="text-right price">${fmt(r.recentPrice)}</td>
                        <td class="text-right price text-yellow-400">${fmt(r.recent90)}</td>
                        <td class="text-right price highlight font-bold text-green-400">${fmt(r.recommendedPrice)}</td>
                        <td class="text-xs">${r.recommendReason || '-'}</td>
                    </tr>`;
            }

            html += `</tbody></table></div>
            
            <div class="mt-4 p-4 bg-gray-800/30 rounded-lg text-xs text-gray-400 space-y-1">
                <p><strong>â€» Rule 1 (BODY2):</strong> ë°¸ë¸Œíƒ€ì… ëìë¦¬ ì œì™¸ í›„ ë‹¨ê°€í…Œì´ë¸” ë§¤í•‘ â†’ ê¸°ë³¸ë‹¨ê°€</p>
                <p><strong>â€» Rule 2 (ì˜µì…˜):</strong> ìì¬ë‚´ì—­ í‚¤ì›Œë“œ ê¸°ë°˜ ì˜µì…˜ë‹¨ê°€ (I/O-P, LOCK, IND, DISC ë“±)</p>
                <p><strong>â€» Rule 3 (ê³„ì•½ë‹¨ê°€):</strong> BODY2 + ì˜µì…˜ë‹¨ê°€ (ìˆ˜ëŸ‰í™˜ì‚° ì ìš©)</p>
                <p><strong>â€» ê³¼ê±°ë°œì£¼ 1ìˆœìœ„:</strong> ë°¸ë¸Œíƒ€ì… + ìì¬ë‚´ì—­ 100% ì¼ì¹˜ | <strong>2ìˆœìœ„:</strong> ë°¸ë¸Œíƒ€ì…ë§Œ ì¼ì¹˜</p>
                <p><strong>â€» ì¶”ì²œë‹¨ê°€:</strong> ê³„ì•½ë‹¨ê°€ì™€ ë°œì£¼ê¸ˆì•¡(ë˜ëŠ” Ã—90%) ì¤‘ ìœ ë¦¬í•œ ê°€ê²©</p>
            </div>`;

            container.innerHTML = html;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Screen 2: í˜‘ë ¥ì‚¬ ê²¬ì  ê²€ì¦
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function runScreen2Analysis() {
            const res = await fetch('/api/screen2/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const data = await res.json();
            
            if (!data.success) throw new Error(data.error || 'ë¶„ì„ ì‹¤íŒ¨');
            
            await renderLogs(data.logs);
            renderScreen2Results(data);
        }

        function renderScreen2Results(data) {
            document.getElementById('screen2-intro').classList.add('hidden');
            const container = document.getElementById('screen2-results');
            container.classList.remove('hidden');

            const goodPct = (data.counts.ìš°ìˆ˜ / Math.max(data.total, 1) * 100).toFixed(1);
            const normalPct = (data.counts.ë³´í†µ / Math.max(data.total, 1) * 100).toFixed(1);
            const badPct = (data.counts.ë¶€ì ì ˆ / Math.max(data.total, 1) * 100).toFixed(1);

            let html = `
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-green-400">${data.counts.ìš°ìˆ˜}</div>
                    <div class="text-xs text-green-300">âœ… ìš°ìˆ˜ (${goodPct}%)</div>
                    <div class="text-xs text-gray-500 mt-1">ë°œì£¼Ã—90% â‰¥ ê²¬ì </div>
                </div>
                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-yellow-400">${data.counts.ë³´í†µ}</div>
                    <div class="text-xs text-yellow-300">ğŸ”¶ ë³´í†µ (${normalPct}%)</div>
                    <div class="text-xs text-gray-500 mt-1">ë°œì£¼/ê³„ì•½ â‰¥ ê²¬ì </div>
                </div>
                <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-red-400">${data.counts.ë¶€ì ì ˆ}</div>
                    <div class="text-xs text-red-300">âŒ ë¶€ì ì ˆ (${badPct}%)</div>
                    <div class="text-xs text-gray-500 mt-1">ê¸°ì¤€ ì´ˆê³¼</div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="prd-table">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>ìì¬ë²ˆí˜¸</th>
                            <th>ë°¸ë¸Œíƒ€ì…</th>
                            <th>ìì¬ë‚´ì—­</th>
                            <th>ê²¬ì ê°€</th>
                            <th>ê³„ì•½ë‹¨ê°€</th>
                            <th>ë°œì£¼ë‹¨ê°€</th>
                            <th>ë°œì£¼Ã—90%</th>
                            <th>ê´´ë¦¬ìœ¨</th>
                            <th>íŒì •</th>
                        </tr>
                    </thead>
                    <tbody>`;

            for (const r of data.results.slice(0, 50)) {
                const badgeClass = r.assessment === 'ìš°ìˆ˜' ? 'text-green-400' 
                    : r.assessment === 'ë¶€ì ì ˆ' ? 'text-red-400' : 'text-yellow-400';
                const gapStr = r.gapPercent !== null ? `${r.gapPercent > 0 ? '+' : ''}${r.gapPercent.toFixed(1)}%` : '-';
                const gapColor = r.gapPercent > 0 ? 'text-red-400' : (r.gapPercent < 0 ? 'text-green-400' : '');

                html += `
                    <tr>
                        <td>${r.no}</td>
                        <td class="font-mono text-xs">${r.materialNo}</td>
                        <td class="text-xs">${r.valveType || '-'}</td>
                        <td class="text-left text-xs" style="max-width:150px"><div class="truncate">${r.description}</div></td>
                        <td class="text-right price">${fmt(r.quotePrice)}</td>
                        <td class="text-right price">${fmt(r.contractPrice)}</td>
                        <td class="text-right price">${fmt(r.recentPrice)}</td>
                        <td class="text-right price text-yellow-400">${fmt(r.recent90)}</td>
                        <td class="${gapColor} font-semibold">${gapStr}</td>
                        <td class="${badgeClass} font-semibold">${r.assessmentLabel}</td>
                    </tr>`;
            }

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Screen 3: ì‹œí™© ë¶„ì„
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function runScreen3Analysis() {
            const res = await fetch('/api/screen3/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const data = await res.json();
            
            if (!data.success) throw new Error(data.error || 'ë¶„ì„ ì‹¤íŒ¨');
            
            await renderLogs(data.logs);
            renderScreen3Results(data);
        }

        function renderScreen3Results(data) {
            document.getElementById('screen3-intro').classList.add('hidden');
            const container = document.getElementById('screen3-results');
            container.classList.remove('hidden');

            const ac = data.assessmentCounts;

            let html = `
            <div class="grid grid-cols-4 gap-3 mb-4">
                <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-orange-400">+${data.summary.cuYearChange}%</div>
                    <div class="text-xs text-gray-400">Cu ì—°ê°„</div>
                </div>
                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-yellow-400">+${data.summary.snYearChange}%</div>
                    <div class="text-xs text-gray-400">Sn ì—°ê°„</div>
                </div>
                <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-blue-400">${data.summary.totalOrders}</div>
                    <div class="text-xs text-gray-400">ë¶„ì„ ê±´ìˆ˜</div>
                </div>
                <div class="bg-gray-700/50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold ${ac.Good >= ac.Bad ? 'text-green-400' : 'text-red-400'}">${ac.Good >= ac.Bad ? 'Good' : 'Bad'}</div>
                    <div class="text-xs text-gray-400">ì „ì²´ íŒì •</div>
                </div>
            </div>

            <div class="bg-gray-800/30 rounded-lg p-4 mb-4">
                <canvas id="trendChart" height="200"></canvas>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-800/30 rounded-lg p-4">
                    <h4 class="font-semibold mb-3 text-sm text-gray-300">ğŸ“Š ì›”ë³„ ì ì •ì„± íŒì •</h4>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        ${Object.entries(data.assessments).map(([m, v]) => {
                            const cls = v.label === 'Good' ? 'text-green-400' : (v.label === 'Bad' ? 'text-red-400' : 'text-yellow-400');
                            return `<div class="flex justify-between bg-gray-700/30 px-2 py-1 rounded"><span>${m}ì›”</span><span class="${cls}">${v.emoji} ${v.label}</span></div>`;
                        }).join('')}
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-700 text-xs text-gray-400">
                        ğŸŸ¢Good: ${ac.Good} | ğŸŸ¡Normal: ${ac.Normal} | ğŸ”´Bad: ${ac.Bad}
                    </div>
                </div>
                <div class="bg-gray-800/30 rounded-lg p-4">
                    <h4 class="font-semibold mb-3 text-sm text-gray-300">ğŸ’¡ í•µì‹¬ ì¸ì‚¬ì´íŠ¸</h4>
                    <div class="text-xs text-gray-300 space-y-2">
                        <p>â€¢ ì‹œí™© +${data.summary.cuYearChange}%(Cu)/+${data.summary.snYearChange}%(Sn) ìƒìŠ¹ì—ë„ ë°œì£¼ë‹¨ê°€ ì•ˆì •</p>
                        <p>â€¢ Good ${ac.Good}ê°œì›”ë¡œ ì‹œí™© ëŒ€ë¹„ ìœ ë¦¬í•œ êµ¬ë§¤ êµ¬ì¡°</p>
                        <p>â€¢ ì›ì¬ë£Œ ë¹„ì¤‘ 80% ê°ì•ˆ ì‹œ í˜‘ìƒ ì—¬ì§€ ì¡´ì¬</p>
                        <p>â€¢ Bad ì›”ì€ ì‹œí™© í•˜ë½ë¶„ ë¯¸ë°˜ì˜ â†’ ì†Œê¸‰ ì¸í•˜ ìš”ì²­</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 p-3 bg-gray-800/30 rounded-lg text-xs text-gray-500">
                â€» ì§€ìˆ˜: 1ì›”=100 ê¸°ì¤€ | Cu+Sn ê°€ì¤‘ì§€ìˆ˜: Cu 88% + Sn 12% (Bronze í•©ê¸ˆ ë¹„ìœ¨)<br>
                â€» ê´´ë¦¬ = ì—…ì²´ì§€ìˆ˜ - ê¸°ëŒ€ì§€ìˆ˜(ì‹œí™©ë³€ë™Ã—80%), ìŒìˆ˜=êµ¬ë§¤ìœ ë¦¬(Good)
            </div>`;

            container.innerHTML = html;
            setTimeout(() => drawTrendChart(data), 100);
        }

        function drawTrendChart(data) {
            const ctx = document.getElementById('trendChart')?.getContext('2d');
            if (!ctx) return;

            const months = data.trendData.map(d => d.monthLabel);
            const cuSnData = data.trendData.map(d => d.cuSnIndex);
            const mainVendorData = data.trendData.map(d => d.mainVendorIndex);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Cu+Sn ê°€ì¤‘ì§€ìˆ˜',
                            data: cuSnData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2.5,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: '#f59e0b',
                        },
                        {
                            label: data.summary.mainVendor ? data.summary.mainVendor.substring(0, 6) : 'ë°œì£¼ë‹¨ê°€',
                            data: mainVendorData,
                            borderColor: '#3b82f6',
                            borderWidth: 2.5,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: '#3b82f6',
                            spanGaps: true,
                        },
                        {
                            label: 'ê¸°ì¤€ì„  (100)',
                            data: Array(12).fill(100),
                            borderColor: 'rgba(255,255,255,0.2)',
                            borderWidth: 1,
                            borderDash: [3, 3],
                            pointRadius: 0,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            labels: { color: '#6b7a94', font: { size: 11 }, usePointStyle: true, padding: 16 }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#e0e6f0',
                            bodyColor: '#94a3b8',
                        }
                    },
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#4b5e78', font: { size: 10 } } },
                        y: { 
                            grid: { color: 'rgba(255,255,255,0.05)' }, 
                            ticks: { color: '#4b5e78', font: { size: 10 } },
                            min: 85, max: 145
                        }
                    }
                }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Initialize
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();
                if (data.status === 'ok') {
                    document.getElementById('apiStatus').innerHTML = 
                        `<i class="fas fa-circle text-[8px] mr-1.5 text-green-400"></i>Python Flask`;
                    document.getElementById('apiStatus').className = 
                        'px-3 py-1.5 bg-green-500/20 text-green-400 rounded-full text-xs font-medium';
                    document.getElementById('dataCount').textContent = 
                        `ë‹¨ê°€ ${data.data.priceTable} | ê²¬ì  ${data.data.quotes} | ì‹¤ì  ${data.data.orders.toLocaleString()}`;
                }
            } catch {
                document.getElementById('apiStatus').innerHTML = 
                    '<i class="fas fa-exclamation-circle text-[8px] mr-1.5"></i>ì—°ê²° ì‹¤íŒ¨';
                document.getElementById('apiStatus').className = 
                    'px-3 py-1.5 bg-red-500/20 text-red-400 rounded-full text-xs font-medium';
            }
        });
    </script>
</body>
</html>
