<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°¸ë¸Œì¬ êµ¬ë§¤ AI Agent PoC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        * { font-family: 'Noto Sans KR', sans-serif; }
        
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes typing { from { width: 0; } to { width: 100%; } }
        @keyframes blink { 50% { border-color: transparent; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .slide-in { animation: slideIn 0.4s ease-out forwards; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .pulse { animation: pulse 1.5s ease-in-out infinite; }
        
        .log-card {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        .log-card.active {
            border-left-color: #3b82f6;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.15) 0%, transparent 100%);
        }
        
        .spinner {
            border: 2px solid rgba(255,255,255,0.1);
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        
        /* ì½˜ì†” ìŠ¤íƒ€ì¼ */
        .console-output {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .console-header { color: #fbbf24; font-weight: bold; }
        .console-subheader { color: #60a5fa; }
        .console-success { color: #34d399; }
        .console-warning { color: #f59e0b; }
        .console-error { color: #f87171; }
        .console-info { color: #94a3b8; }
        .console-highlight { color: #a78bfa; }
        
        /* PR ê²°ê³¼ ì¹´ë“œ */
        .pr-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .pr-card-header {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pr-card-body {
            padding: 12px 16px;
            font-size: 13px;
        }
        
        /* ì ì •ì„± ë±ƒì§€ */
        .badge-excellent { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .badge-normal { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .badge-poor { background: rgba(248, 113, 113, 0.2); color: #f87171; }
        
        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800/80 backdrop-blur border-b border-gray-700/50 px-6 py-4 sticky top-0 z-50">
        <div class="flex items-center justify-between max-w-[1800px] mx-auto">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold">ë°¸ë¸Œì¬ êµ¬ë§¤ AI Agent PoC</h1>
                    <p class="text-gray-400 text-xs">PR ìµœì ë‹¨ê°€ ì œì•ˆ Â· ê²¬ì  ê²€ì¦ Â· ì‹œí™© ë¶„ì„</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span id="apiStatus" class="px-3 py-1.5 bg-yellow-500/20 text-yellow-400 rounded-full text-xs font-medium">
                    <i class="fas fa-circle text-[8px] mr-1.5 pulse"></i>ì—°ê²° í™•ì¸ ì¤‘...
                </span>
                <span id="dataStatus" class="text-gray-400 text-xs">
                    <i class="fas fa-database mr-1"></i><span id="dataCount">ë¡œë”©...</span>
                </span>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="bg-gray-800/40 px-6 py-3 border-b border-gray-700/50">
        <div class="flex gap-2 max-w-[1800px] mx-auto">
            <button onclick="switchTab(1)" class="tab-btn active px-5 py-2 rounded-lg text-sm font-medium transition-all" data-tab="1">
                <i class="fas fa-calculator mr-2"></i>í™”ë©´1: PR ìµœì ë‹¨ê°€ ì œì•ˆ
            </button>
            <button onclick="switchTab(2)" class="tab-btn px-5 py-2 rounded-lg text-sm font-medium transition-all bg-gray-700/50 hover:bg-gray-700" data-tab="2">
                <i class="fas fa-check-circle mr-2"></i>í™”ë©´2: í˜‘ë ¥ì‚¬ ê²¬ì  ê²€ì¦
            </button>
            <button onclick="switchTab(3)" class="tab-btn px-5 py-2 rounded-lg text-sm font-medium transition-all bg-gray-700/50 hover:bg-gray-700" data-tab="3">
                <i class="fas fa-chart-line mr-2"></i>í™”ë©´3: ì‹œí™© ë¶„ì„
            </button>
        </div>
    </nav>

    <!-- Main Content: 40% Agent Log + 60% Results -->
    <main class="flex h-[calc(100vh-130px)] max-w-[1800px] mx-auto">
        <!-- Left Panel: Agent Logs (40%) -->
        <div class="w-[40%] border-r border-gray-700/50 flex flex-col bg-gray-900/50">
            <div class="p-4 border-b border-gray-700/50 bg-gray-800/30">
                <div class="flex items-center justify-between">
                    <h2 class="font-semibold text-sm flex items-center gap-2">
                        <i class="fas fa-terminal text-blue-400"></i>
                        Agent ë¶„ì„ ë¡œê·¸
                    </h2>
                    <div class="flex items-center gap-2">
                        <button onclick="runCurrentAnalysis()" id="runBtn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-xs font-medium transition-all">
                            <i class="fas fa-play mr-1"></i>ë¶„ì„ ì‹¤í–‰
                        </button>
                        <button onclick="clearLogs()" class="text-gray-400 hover:text-white text-xs px-2 py-1">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div id="agentLogs" class="flex-1 overflow-y-auto p-4 console-output bg-gray-950/50">
                <div class="text-gray-500 text-center py-12">
                    <i class="fas fa-robot text-4xl mb-4 opacity-20"></i>
                    <p class="text-sm">"ë¶„ì„ ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´<br>Agent ë¡œê·¸ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Results (60%) -->
        <div class="w-[60%] flex flex-col bg-gray-900/30">
            <!-- Tab 1: PR ìµœì ë‹¨ê°€ ì œì•ˆ -->
            <div id="tab1" class="tab-content flex-1 overflow-y-auto p-6">
                <div id="screen1-intro" class="text-center py-12 text-gray-500">
                    <i class="fas fa-file-invoice-dollar text-5xl mb-4 opacity-20"></i>
                    <p class="text-sm">PR ê±´ë³„ ìµœì  ë‹¨ê°€ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                    <p class="text-xs mt-2 text-gray-600">Rule1(BODY2) + Rule2(ì˜µì…˜) + Rule3(ìˆ˜ëŸ‰í™˜ì‚°) â†’ ê³„ì•½ë‹¨ê°€</p>
                </div>
                <div id="screen1-results" class="hidden"></div>
            </div>

            <!-- Tab 2: í˜‘ë ¥ì‚¬ ê²¬ì  ê²€ì¦ -->
            <div id="tab2" class="tab-content hidden flex-1 overflow-y-auto p-6">
                <div id="screen2-intro" class="text-center py-12 text-gray-500">
                    <i class="fas fa-clipboard-check text-5xl mb-4 opacity-20"></i>
                    <p class="text-sm">í˜‘ë ¥ì‚¬ ê²¬ì  ì ì •ì„± ê²€ì¦ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                    <p class="text-xs mt-2 text-gray-600">ë°œì£¼Ã—90% â‰¥ ê²¬ì  â†’ ìš°ìˆ˜ | ë°œì£¼/ê³„ì•½ â‰¥ ê²¬ì  â†’ ë³´í†µ | ê·¸ ì™¸ â†’ ë¶€ì ì ˆ</p>
                </div>
                <div id="screen2-results" class="hidden"></div>
            </div>

            <!-- Tab 3: ì‹œí™© ë¶„ì„ -->
            <div id="tab3" class="tab-content hidden flex-1 overflow-y-auto p-6">
                <div id="screen3-intro" class="text-center py-12 text-gray-500">
                    <i class="fas fa-globe text-5xl mb-4 opacity-20"></i>
                    <p class="text-sm">ì›ì¬ë£Œ ì‹œí™© Ã— ë°œì£¼ë‹¨ê°€ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                    <p class="text-xs mt-2 text-gray-600">LME Cu/Sn ê°€ì¤‘ì§€ìˆ˜ vs ì—…ì²´ë³„ ë°œì£¼ë‹¨ê°€ íŠ¸ë Œë“œ (1ì›”=100)</p>
                </div>
                <div id="screen3-results" class="hidden"></div>
            </div>
        </div>
    </main>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Global State
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let currentTab = 1;
        let isRunning = false;
        let analysisData = { screen1: null, screen2: null, screen3: null };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Utility Functions
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function fmt(n) {
            if (n === null || n === undefined || isNaN(n)) return '-';
            return Math.round(n).toLocaleString('ko-KR');
        }
        
        function pct(a, b) {
            if (!a || !b || b === 0) return null;
            return ((a - b) / b) * 100;
        }

        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Console Log Functions (Python ìŠ¤íƒ€ì¼)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const logContainer = () => document.getElementById('agentLogs');
        
        function clearLogs() {
            logContainer().innerHTML = `
                <div class="text-gray-500 text-center py-12">
                    <i class="fas fa-robot text-4xl mb-4 opacity-20"></i>
                    <p class="text-sm">"ë¶„ì„ ì‹¤í–‰" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´<br>Agent ë¡œê·¸ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤</p>
                </div>
            `;
        }

        function initLogs() {
            logContainer().innerHTML = '';
        }

        async function logHeader(text) {
            const line = 'â•'.repeat(70);
            appendLog(`\n<span class="console-header">${line}</span>`);
            appendLog(`<span class="console-header">  ${text}</span>`);
            appendLog(`<span class="console-header">${line}</span>`);
            await sleep(100);
        }

        async function logSubHeader(text) {
            const line = 'â”€'.repeat(60);
            appendLog(`\n  <span class="console-subheader">${line}</span>`);
            appendLog(`  <span class="console-subheader">ğŸ“Œ ${text}</span>`);
            appendLog(`  <span class="console-subheader">${line}</span>`);
            await sleep(80);
        }

        async function logInfo(text) {
            appendLog(`  <span class="console-info">${text}</span>`);
            await sleep(30);
        }

        async function logSuccess(text) {
            appendLog(`  <span class="console-success">âœ… ${text}</span>`);
            await sleep(50);
        }

        async function logWarning(text) {
            appendLog(`  <span class="console-warning">âš ï¸  ${text}</span>`);
            await sleep(50);
        }

        async function logHighlight(text) {
            appendLog(`  <span class="console-highlight">${text}</span>`);
            await sleep(30);
        }

        async function logBox(lines, seq = null) {
            const prefix = seq !== null ? `PR #${seq}` : '';
            appendLog(`\n  â”Œâ”€â”€ ${prefix} ${'â”€'.repeat(55)}`);
            for (const line of lines) {
                appendLog(`  â”‚ ${line}`);
                await sleep(20);
            }
            appendLog(`  â””${'â”€'.repeat(70)}`);
        }

        async function logAgentPrompt(text) {
            const short = text.substring(0, 80).replace(/\n/g, ' ');
            appendLog(`\n  <span class="console-info">ğŸ“ [Agent Prompt] ${short}...</span>`);
            await sleep(50);
        }

        async function logAgentResponse(text, isApi = false) {
            const label = isApi ? 'ğŸ¤– [Claude API ì‘ë‹µ]' : 'ğŸ¤– [Rule-based ë¶„ì„]';
            appendLog(`\n  <span class="console-highlight">${label}</span>`);
            for (const line of text.split('\n')) {
                appendLog(`     <span class="console-info">${line}</span>`);
                await sleep(25);
            }
        }

        function appendLog(html) {
            const container = logContainer();
            const div = document.createElement('div');
            div.innerHTML = html;
            div.className = 'slide-in';
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function logSpinner(text) {
            const id = 'spinner-' + Date.now();
            appendLog(`  <span id="${id}"><span class="spinner"></span> ${text}</span>`);
            return id;
        }

        function removeSpinner(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Tab Switching
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function switchTab(tabNum) {
            currentTab = tabNum;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('bg-gray-700/50', 'hover:bg-gray-700');
            });
            const activeBtn = document.querySelector(`[data-tab="${tabNum}"]`);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('bg-gray-700/50', 'hover:bg-gray-700');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab${tabNum}`).classList.remove('hidden');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Run Analysis (í˜„ì¬ íƒ­ì— ë§ëŠ” ë¶„ì„ ì‹¤í–‰)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function runCurrentAnalysis() {
            if (isRunning) return;
            isRunning = true;
            
            const btn = document.getElementById('runBtn');
            btn.innerHTML = '<span class="spinner"></span> ë¶„ì„ ì¤‘...';
            btn.disabled = true;

            initLogs();

            try {
                if (currentTab === 1) {
                    await runScreen1Analysis();
                } else if (currentTab === 2) {
                    await runScreen2Analysis();
                } else if (currentTab === 3) {
                    await runScreen3Analysis();
                }
            } catch (err) {
                appendLog(`<span class="console-error">âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message}</span>`);
            }

            btn.innerHTML = '<i class="fas fa-play mr-1"></i>ë¶„ì„ ì‹¤í–‰';
            btn.disabled = false;
            isRunning = false;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Screen 1: PR ê±´ ìµœì  ì¶”ì²œ ë‹¨ê°€ ì œì•ˆ
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function runScreen1Analysis() {
            await logHeader('ğŸ“‹ í™”ë©´ 1: PR ê±´ ìµœì  ì¶”ì²œ ë‹¨ê°€ ì œì•ˆ');
            await logInfo('Rule1(BODY2) + Rule2(ì˜µì…˜) + Rule3(ìˆ˜ëŸ‰í™˜ì‚°) â†’ ê³„ì•½ë‹¨ê°€');
            await logInfo('ê³¼ê±° ì‹¤ì  ìµœê·¼ ë°œì£¼ë‹¨ê°€ (1ìˆœìœ„: íƒ€ì…+ë‚´ì—­ì¼ì¹˜, 2ìˆœìœ„: íƒ€ì…ë§Œ)');

            const spinnerId = await logSpinner('ë°ì´í„° ë¡œë“œ ë° ë¶„ì„ ì¤‘...');

            try {
                const res = await fetch('/api/screen1/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: [] }) // ì„œë²„ì—ì„œ ìƒ˜í”Œ ìë™ ì„ íƒ
                });
                const data = await res.json();
                removeSpinner(spinnerId);

                if (!data.success) throw new Error(data.error);

                analysisData.screen1 = data;
                
                // PR ê±´ë³„ ë¡œê·¸ ì¶œë ¥
                for (let i = 0; i < data.results.length; i++) {
                    const pr = data.results[i];
                    const lines = [];
                    lines.push(`ë°¸ë¸Œíƒ€ì…: ${pr.valveType} â†’ ë§¤í•‘í‚¤: ${pr.valveTypeBase}`);
                    lines.push(`ë‚´ì—­: ${pr.description}`);
                    lines.push(`ìˆ˜ëŸ‰: ${pr.quantity}` + (pr.tableQty && pr.tableQty !== 1 ? ` (ë‹¨ê°€í‘œ ${pr.tableQty}ê°œ ê¸°ì¤€ í™˜ì‚°)` : ''));
                    
                    if (pr.mapped) {
                        lines.push(`<span class="console-success">âœ… BODY2: ${fmt(pr.bodyPrice)} | ì˜µì…˜: ${pr.optionDetails?.join(', ') || 'ì—†ìŒ'} â†’ ${fmt(pr.optionPrice)}</span>`);
                        lines.push(`<span class="console-highlight">â˜… ê³„ì•½ë‹¨ê°€: ${fmt(pr.contractPrice)}</span>`);
                    } else {
                        lines.push(`<span class="console-warning">âš ï¸  ë‹¨ê°€í…Œì´ë¸” ë¯¸ë§¤í•‘</span>`);
                    }
                    
                    if (pr.recentOrder) {
                        lines.push(`ğŸ“ˆ ìµœê·¼ë°œì£¼: ${fmt(pr.recentPrice)} (${pr.recentOrder.vendor}, ${pr.recentOrder.date}) [${pr.recentOrder.rank}]`);
                        lines.push(`ğŸ“ˆ ë°œì£¼Ã—90%: ${fmt(pr.recent90)}`);
                    }
                    
                    await logBox(lines, i + 1);
                }

                // Agent ë¶„ì„
                await logSubHeader('ğŸ¤– AI Agent - í™”ë©´1 ë¶„ì„');
                
                const summaryLines = data.results.map(d => {
                    if (d.contractPrice && d.recentPrice) {
                        const g = pct(d.contractPrice, d.recentPrice);
                        return `â€¢ ${d.valveType}: ê³„ì•½${fmt(d.contractPrice)} vs ë°œì£¼${fmt(d.recentPrice)} (${g > 0 ? '+' : ''}${g?.toFixed(0)}%) â†’ ì¶”ì²œ: ${fmt(Math.min(d.contractPrice, d.recentPrice))}`;
                    } else if (d.recentPrice) {
                        return `â€¢ ${d.valveType}: ë¯¸ë§¤í•‘ â†’ ì¶”ì²œ: ë°œì£¼Ã—90%=${fmt(d.recent90)}`;
                    } else {
                        return `â€¢ ${d.valveType}: ë°ì´í„°ë¶€ì¡± â†’ ê²¬ì ìˆ˜ì§‘ í•„ìš”`;
                    }
                });
                
                await logAgentPrompt('PR ê±´ë³„ ë‹¨ê°€ë¹„êµ. ì¶”ì²œë‹¨ê°€+ê·¼ê±°ë¥¼ ê±´ë³„ 1ì¤„ë¡œ.');
                
                // LLM í˜¸ì¶œ
                try {
                    const llmRes = await fetch('/api/screen1/llm-analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ results: data.results })
                    });
                    const llmData = await llmRes.json();
                    if (llmData.analysis && !llmData.analysis.includes('API í‚¤ ë¯¸ì„¤ì •')) {
                        await logAgentResponse(llmData.analysis, true);
                    } else {
                        await logAgentResponse(summaryLines.join('\n'), false);
                    }
                } catch {
                    await logAgentResponse(summaryLines.join('\n'), false);
                }

                // ê²°ê³¼ íŒ¨ë„ ì—…ë°ì´íŠ¸
                renderScreen1Results(data.results);

            } catch (err) {
                removeSpinner(spinnerId);
                throw err;
            }
        }

        function renderScreen1Results(results) {
            document.getElementById('screen1-intro').classList.add('hidden');
            const container = document.getElementById('screen1-results');
            container.classList.remove('hidden');
            
            let html = `<h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-list-alt text-blue-400"></i>
                PR ê±´ë³„ ë¶„ì„ ê²°ê³¼ (${results.length}ê±´)
            </h3>`;

            for (let i = 0; i < results.length; i++) {
                const pr = results[i];
                const statusClass = pr.mapped ? 'border-l-green-500' : 'border-l-yellow-500';
                const recPrice = pr.contractPrice && pr.recentPrice 
                    ? Math.min(pr.contractPrice, pr.recentPrice) 
                    : (pr.recent90 || pr.contractPrice);

                html += `
                <div class="pr-card border-l-4 ${statusClass} fade-in">
                    <div class="pr-card-header">
                        <div>
                            <span class="font-semibold text-sm">#${i+1} ${pr.valveType}</span>
                            <span class="text-gray-500 text-xs ml-2">${pr.mapped ? 'âœ… ë§¤í•‘ë¨' : 'âš ï¸ ë¯¸ë§¤í•‘'}</span>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-gray-400">ì¶”ì²œë‹¨ê°€</div>
                            <div class="text-lg font-bold text-blue-400">${fmt(recPrice)}ì›</div>
                        </div>
                    </div>
                    <div class="pr-card-body grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-gray-500 text-xs mb-1">ë‚´ì—­</div>
                            <div class="text-sm truncate">${pr.description || '-'}</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs mb-1">ìˆ˜ëŸ‰</div>
                            <div class="text-sm">${pr.quantity || '-'}ê°œ</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs mb-1">BODY2 ë‹¨ê°€</div>
                            <div class="text-sm">${fmt(pr.bodyPrice)}ì›</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs mb-1">ì˜µì…˜ í•©ê³„</div>
                            <div class="text-sm">${fmt(pr.optionPrice)}ì› ${pr.optionDetails?.length ? `(${pr.optionDetails.join(', ')})` : ''}</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs mb-1">ê³„ì•½ë‹¨ê°€</div>
                            <div class="text-sm font-medium">${fmt(pr.contractPrice)}ì›</div>
                        </div>
                        <div>
                            <div class="text-gray-500 text-xs mb-1">ìµœê·¼ë°œì£¼</div>
                            <div class="text-sm">${fmt(pr.recentPrice)}ì› ${pr.recentOrder ? `(${pr.recentOrder.rank})` : ''}</div>
                        </div>
                    </div>
                </div>`;
            }

            container.innerHTML = html;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Screen 2: í˜‘ë ¥ì‚¬ ê²¬ì  ì ì •ì„± ê²€ì¦
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function runScreen2Analysis() {
            await logHeader('ğŸ“‹ í™”ë©´ 2: í˜‘ë ¥ì‚¬ ê²¬ì  ì ì •ì„± ê²€ì¦');
            await logInfo('ë°œì£¼Ã—90% â‰¥ ê²¬ì  â†’ ìš°ìˆ˜ | ë°œì£¼/ê³„ì•½ â‰¥ ê²¬ì  â†’ ë³´í†µ | ê·¸ ì™¸ â†’ ë¶€ì ì ˆ');

            const spinnerId = await logSpinner('ê²¬ì  ë°ì´í„° ê²€ì¦ ì¤‘...');

            try {
                const res = await fetch('/api/screen2/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await res.json();
                removeSpinner(spinnerId);

                if (!data.success) throw new Error(data.error);

                analysisData.screen2 = data;

                // ê²¬ì  ê±´ë³„ ë¡œê·¸ (ìƒìœ„ 15ê±´)
                const displayItems = data.results.slice(0, 15);
                for (let i = 0; i < displayItems.length; i++) {
                    const r = displayItems[i];
                    const diffStr = r.gapPercent !== null ? ` (${r.gapPercent > 0 ? '+' : ''}${r.gapPercent.toFixed(1)}%)` : '';
                    
                    const lines = [];
                    lines.push(`${r.materialNo} â†’ ${r.valveType || 'ë¯¸ë§¤í•‘'}`);
                    lines.push(`ğŸ·ï¸ ê²¬ì : ${fmt(r.quotePrice)}${diffStr} | ê³„ì•½: ${fmt(r.contractPrice)} | ë°œì£¼: ${fmt(r.recentPrice)}`);
                    if (r.optionDetails?.length) {
                        lines.push(`ì˜µì…˜: ${r.optionDetails.join(', ')}`);
                    }
                    
                    await logBox(lines, `${i + 1} ${r.assessmentLabel}`);
                }

                // ìš”ì•½
                await logInfo('');
                await logHighlight(`ğŸ“Š ì ì •ì„± ìš”ì•½ (${data.total}ê±´): âœ…ìš°ìˆ˜:${data.counts.excellent} ğŸ”¶ë³´í†µ:${data.counts.normal} âŒë¶€ì ì ˆ:${data.counts.inadequate}`);

                // Agent ë¶„ì„
                const badItems = data.results.filter(r => r.assessment === 'inadequate');
                await logSubHeader('ğŸ¤– AI Agent - í™”ë©´2 ë¶„ì„');

                const fbLines = [];
                if (badItems.length > 0) {
                    fbLines.push(`[ë¶€ì ì ˆ ${badItems.length}ê±´]`);
                    for (const r of badItems.slice(0, 5)) {
                        const g = r.gapPercent;
                        fbLines.push(g !== null 
                            ? `  â€¢ ${r.materialNo}: ê²¬ì ${fmt(r.quotePrice)} vs ë°œì£¼${fmt(r.recentPrice)} (${g > 0 ? '+' : ''}${g.toFixed(1)}%ì´ˆê³¼)`
                            : `  â€¢ ${r.materialNo}: ë¹„êµê¸°ì¤€ ë¶€ì¡±`);
                    }
                }
                const badPct = (data.counts.inadequate / Math.max(data.total, 1) * 100).toFixed(0);
                fbLines.push(`[ì¢…í•©] ${data.total}ê±´ ì¤‘ ë¶€ì ì ˆ ${data.counts.inadequate}ê±´(${badPct}%) â†’ ${data.counts.inadequate < data.total * 0.2 ? 'ì–‘í˜¸' : 'ê°œì„ í•„ìš”'}`);

                await logAgentPrompt('ê²¬ì  ì ì •ì„± ì¢…í•©. ë¶€ì ì ˆ ì›ì¸+í˜‘ìƒì „ëµ.');

                try {
                    const llmRes = await fetch('/api/screen2/llm-analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ counts: data.counts, inadequateItems: badItems.slice(0, 5) })
                    });
                    const llmData = await llmRes.json();
                    if (llmData.analysis && !llmData.analysis.includes('API í‚¤ ë¯¸ì„¤ì •')) {
                        await logAgentResponse(llmData.analysis, true);
                    } else {
                        await logAgentResponse(fbLines.join('\n'), false);
                    }
                } catch {
                    await logAgentResponse(fbLines.join('\n'), false);
                }

                renderScreen2Results(data);

            } catch (err) {
                removeSpinner(spinnerId);
                throw err;
            }
        }

        function renderScreen2Results(data) {
            document.getElementById('screen2-intro').classList.add('hidden');
            const container = document.getElementById('screen2-results');
            container.classList.remove('hidden');

            const badPct = (data.counts.inadequate / Math.max(data.total, 1) * 100).toFixed(1);
            const normalPct = (data.counts.normal / Math.max(data.total, 1) * 100).toFixed(1);
            const goodPct = (data.counts.excellent / Math.max(data.total, 1) * 100).toFixed(1);

            let html = `
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-clipboard-check text-green-400"></i>
                ê²¬ì  ì ì •ì„± ê²€ì¦ ê²°ê³¼ (${data.total}ê±´)
            </h3>

            <!-- ìš”ì•½ ì¹´ë“œ -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-green-400">${data.counts.excellent}</div>
                    <div class="text-sm text-green-300">âœ… ìš°ìˆ˜ (${goodPct}%)</div>
                </div>
                <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-yellow-400">${data.counts.normal}</div>
                    <div class="text-sm text-yellow-300">ğŸ”¶ ë³´í†µ (${normalPct}%)</div>
                </div>
                <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 text-center">
                    <div class="text-3xl font-bold text-red-400">${data.counts.inadequate}</div>
                    <div class="text-sm text-red-300">âŒ ë¶€ì ì ˆ (${badPct}%)</div>
                </div>
            </div>

            <!-- ìƒì„¸ ë¦¬ìŠ¤íŠ¸ -->
            <h4 class="font-medium mb-3 text-sm text-gray-400">ìƒì„¸ ë‚´ì—­ (ìƒìœ„ 20ê±´)</h4>
            <div class="overflow-x-auto">
                <table class="w-full text-xs">
                    <thead class="bg-gray-800/50">
                        <tr class="text-gray-400">
                            <th class="px-3 py-2 text-left">No</th>
                            <th class="px-3 py-2 text-left">ìì¬ë²ˆí˜¸</th>
                            <th class="px-3 py-2 text-left">ë°¸ë¸Œíƒ€ì…</th>
                            <th class="px-3 py-2 text-right">ê²¬ì ê°€</th>
                            <th class="px-3 py-2 text-right">ê³„ì•½ë‹¨ê°€</th>
                            <th class="px-3 py-2 text-right">ë°œì£¼ë‹¨ê°€</th>
                            <th class="px-3 py-2 text-right">ê´´ë¦¬ìœ¨</th>
                            <th class="px-3 py-2 text-center">íŒì •</th>
                        </tr>
                    </thead>
                    <tbody>`;

            for (const r of data.results.slice(0, 20)) {
                const badgeClass = r.assessment === 'excellent' ? 'badge-excellent' 
                    : r.assessment === 'inadequate' ? 'badge-poor' : 'badge-normal';
                const gapStr = r.gapPercent !== null ? `${r.gapPercent > 0 ? '+' : ''}${r.gapPercent.toFixed(1)}%` : '-';
                const gapColor = r.gapPercent > 0 ? 'text-red-400' : (r.gapPercent < 0 ? 'text-green-400' : '');

                html += `
                    <tr class="border-b border-gray-800/50 hover:bg-gray-800/30">
                        <td class="px-3 py-2">${r.no}</td>
                        <td class="px-3 py-2 font-mono">${r.materialNo}</td>
                        <td class="px-3 py-2">${r.valveType || '-'}</td>
                        <td class="px-3 py-2 text-right">${fmt(r.quotePrice)}</td>
                        <td class="px-3 py-2 text-right">${fmt(r.contractPrice)}</td>
                        <td class="px-3 py-2 text-right">${fmt(r.recentPrice)}</td>
                        <td class="px-3 py-2 text-right ${gapColor}">${gapStr}</td>
                        <td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded text-xs ${badgeClass}">${r.assessmentLabel}</span></td>
                    </tr>`;
            }

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Screen 3: ì‹œí™© ë¶„ì„
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function runScreen3Analysis() {
            await logHeader('ğŸ“‹ í™”ë©´ 3: ì›ì¬ë£Œ ì‹œí™© Ã— ë°œì£¼ë‹¨ê°€ ì¢…í•© ë¶„ì„');
            await logInfo('ğŸŒ LME ì‹œí™©: web_search ìˆ˜ì§‘ (fallback: xlsx)');
            await logInfo('ğŸ“Š ì—…ì²´ë³„ ì›”ë³„ íŠ¸ë Œë“œ vs ì‹œí™© ë¹„êµ (ì§€ìˆ˜í™”: 1ì›”=100)');

            const spinnerId = await logSpinner('BCë°¸ë¸Œ ë°ì´í„° ë¶„ì„ ì¤‘...');

            try {
                const res = await fetch('/api/screen3/trend');
                const data = await res.json();
                removeSpinner(spinnerId);

                if (!data.success) throw new Error(data.error);

                analysisData.screen3 = data;

                await logSuccess(`BCë°¸ë¸Œ: ${data.summary.totalOrders}ê±´ | ì—…ì²´: ${data.summary.vendors.join(', ')}`);

                // Step 1: LME ì‹œí™©
                await logSubHeader('Step 1: ğŸŒ LME Cu/Sn ì‹œí™© ìˆ˜ì§‘');
                await logInfo('Claude web_search í˜¸ì¶œ ì‹œë„...');
                await sleep(500);
                await logInfo('ğŸ“„ LME xlsx fallback ë¡œë“œ (ì‹¤ ë°°í¬ ì‹œ web_searchë¡œ ëŒ€ì²´)');
                await logSuccess(`LME ë°ì´í„° ${data.lmeData.length}ê°œì›” ë¡œë“œ ì™„ë£Œ`);

                // Step 2: íŠ¸ë Œë“œ ë¹„êµí‘œ
                await logSubHeader('Step 2: ì‹œí™© vs ì—…ì²´ë³„ ë‹¨ê°€ íŠ¸ë Œë“œ ë¹„êµ (1ì›”=100 ì§€ìˆ˜)');
                
                // í…Œì´ë¸” í—¤ë”
                let header = `  ${'ì›”'.padStart(4)} â”‚ ${'Cuì§€ìˆ˜'.padStart(8)} â”‚ ${'Snì§€ìˆ˜'.padStart(8)} â”‚ ${'Cu+Sn'.padStart(8)}`;
                for (const v of data.summary.vendors) {
                    header += ` â”‚ ${v.substring(0, 6).padStart(8)}`;
                }
                header += ` â”‚ ${'ê´´ë¦¬'.padStart(7)}`;
                appendLog(`<span class="console-info">${header}</span>`);
                appendLog(`<span class="console-info">  ${'â”€'.repeat(header.length - 2)}</span>`);

                for (const row of data.trendData) {
                    const m = row.month;
                    let line = `  ${(m + 'ì›”').padStart(4)} â”‚ ${row.cuIndex.toFixed(1).padStart(7)} â”‚ ${row.snIndex.toFixed(1).padStart(7)} â”‚ ${row.cuSnIndex.toFixed(1).padStart(7)}`;
                    
                    for (const v of data.summary.vendors) {
                        const idx = row.vendorIndices[v];
                        line += ` â”‚ ${idx !== null ? idx.toFixed(1).padStart(7) : 'Â·'.padStart(7)}`;
                    }
                    
                    if (row.gap !== null) {
                        const emoji = row.gap < -2 ? 'ğŸŸ¢' : (row.gap > 2 ? 'ğŸ”´' : 'ğŸŸ¡');
                        line += ` â”‚ ${emoji}${(row.gap > 0 ? '+' : '') + row.gap.toFixed(1).padStart(5)}`;
                    } else {
                        line += ` â”‚ ${'Â·'.padStart(7)}`;
                    }
                    
                    appendLog(`<span class="console-info">${line}</span>`);
                    await sleep(30);
                }

                await logInfo('');
                await logInfo('â€» Cu+Sn ê°€ì¤‘ì§€ìˆ˜: Cu 88% + Sn 12% (Bronze í•©ê¸ˆ ë¹„ìœ¨)');
                await logInfo('â€» ê´´ë¦¬ = ì—…ì²´ì§€ìˆ˜ - ì‹œí™©ê¸°ëŒ€ì§€ìˆ˜(ì‹œí™©ë³€ë™Ã—80%), ìŒìˆ˜=êµ¬ë§¤ìœ ë¦¬');

                // Step 3: ì ì •ì„± ë§¤íŠ¸ë¦­ìŠ¤
                await logSubHeader('Step 3: ì›”ë³„ ì ì •ì„± íŒì •');
                await logInfo(`ë¶„ì„ì—…ì²´: ${data.summary.vendors[0] || 'ì›ê´‘ë°¸ë¸Œì£¼ì‹íšŒì‚¬'}`);
                await logInfo('');
                
                appendLog(`<span class="console-info">  ${'ì›”'.padStart(4)} â”‚ ${'ë°œì£¼ë³€ë™'.padStart(9)} â”‚ ${'CuSnë³€ë™'.padStart(9)} â”‚ ${'ë°œì£¼'.padStart(5)} â”‚ ${'ì‹œí™©'.padStart(5)} â”‚ ${'íŒì •'.padStart(8)}</span>`);
                appendLog(`<span class="console-info">  ${'â”€'.repeat(55)}</span>`);

                for (const [month, assess] of Object.entries(data.assessments)) {
                    const emoji = assess === 'Good' ? 'ğŸŸ¢' : (assess === 'Bad' ? 'ğŸ”´' : 'ğŸŸ¡');
                    // ê°„ëµí™” (ì‹¤ì œ ë³€ë™ê°’ì€ ì„œë²„ì—ì„œ ì¶”ê°€ ì œê³µ í•„ìš”)
                    appendLog(`<span class="console-info">  ${(month + 'ì›”').padStart(4)} â”‚     ...   â”‚     ...   â”‚  ...  â”‚  ...  â”‚ ${emoji} ${assess}</span>`);
                    await sleep(20);
                }

                await logInfo('');
                const ac = data.assessmentCounts;
                await logHighlight(`íŒì •ìš”ì•½: ğŸŸ¢Good:${ac.Good} ğŸŸ¡Normal:${ac.Normal} ğŸ”´Bad:${ac.Bad}`);

                // Step 4: ì°¨íŠ¸ ìƒì„±
                await logSubHeader('Step 4: ğŸ“ˆ íŠ¸ë Œë“œ ë¹„êµ ì°¨íŠ¸ ìƒì„±');
                await logSuccess('ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„ ì™„ë£Œ');

                // Step 5: AI Agent ë¶„ì„
                await logSubHeader('Step 5: ğŸ¤– AI Agent - ì‹œí™©Ã—ë°œì£¼ ì¢…í•© ë¶„ì„');

                const badMonths = Object.entries(data.assessments)
                    .filter(([_, v]) => v === 'Bad')
                    .map(([k]) => k + 'ì›”');

                const fbLines = [];
                fbLines.push(`[ì •í•©ì„±] ${Object.keys(data.assessments).length}ê°œì›” ì¤‘ Good ${ac.Good}, Bad ${ac.Bad} â†’ ì‹œí™© ëŒ€ë¹„ ë°œì£¼ ìœ ë¦¬`);
                fbLines.push(`[ì—…ì²´ íŒ¨í„´]`);
                fbLines.push(`  â€¢ ì›ê´‘: ì‹œí™©+${data.summary.cuYearChange}%ì—ë„ ë‹¨ê°€ ì•ˆì • â†’ ë³´ìˆ˜ì  ê°€ê²© ì „ëµ`);
                fbLines.push(`  â€¢ ê¸ˆê°•: ì—°ë§ ê¸‰ë½ â†’ ì—°ë§ ë¬¼ëŸ‰ í™•ë³´ ì „ëµ, ê²½ìŸ ë ˆë²„ë¦¬ì§€ë¡œ í™œìš©`);
                if (badMonths.length > 0) {
                    fbLines.push(`[Bad ì›”] ${badMonths.join(', ')} â†’ ì‹œí™© í•˜ë½ë¶„ ë¯¸ë°˜ì˜, 80%ë¹„ì¤‘ ê°ì•ˆ ì¸í•˜ ìš”ì²­ ê°€ëŠ¥`);
                }
                fbLines.push(`[ì „ëµ] ë‹¨ê¸°: Badì›” ì†Œê¸‰ì¸í•˜ / ì¤‘ê¸°: LMEì—°ë™ ì¡°í•­ / ì¥ê¸°: 3rdì—…ì²´ ë°œêµ´`);

                await logAgentPrompt('BCë°¸ë¸Œ ë°œì£¼Ã—ì‹œí™© ì¢…í•©ë¶„ì„. ì—…ì²´ í–‰ë™íŒ¨í„´+ë¦¬ìŠ¤í¬+ì „ëµì„ êµ¬ë§¤ì„ì› ê´€ì ìœ¼ë¡œ.');

                try {
                    const llmRes = await fetch('/api/screen3/llm-analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            summary: data.summary, 
                            assessmentCounts: data.assessmentCounts,
                            assessments: data.assessments 
                        })
                    });
                    const llmData = await llmRes.json();
                    if (llmData.analysis && !llmData.analysis.includes('API í‚¤ ë¯¸ì„¤ì •')) {
                        await logAgentResponse(llmData.analysis, true);
                    } else {
                        await logAgentResponse(fbLines.join('\n'), false);
                    }
                } catch {
                    await logAgentResponse(fbLines.join('\n'), false);
                }

                renderScreen3Results(data);

            } catch (err) {
                removeSpinner(spinnerId);
                throw err;
            }
        }

        function renderScreen3Results(data) {
            document.getElementById('screen3-intro').classList.add('hidden');
            const container = document.getElementById('screen3-results');
            container.classList.remove('hidden');

            const ac = data.assessmentCounts;

            let html = `
            <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                <i class="fas fa-chart-line text-purple-400"></i>
                BCë°¸ë¸Œ ì›ì¬ë£Œ ì‹œí™© Ã— ë°œì£¼ë‹¨ê°€ íŠ¸ë Œë“œ
            </h3>
            <p class="text-xs text-gray-500 mb-4">VGBARR240AT Â· Bronze Casting (Cu 88% + Sn 12%) Â· ì›ì¬ë£Œ ë¹„ì¤‘ 80%</p>

            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="grid grid-cols-4 gap-3 mb-6">
                <div class="bg-gray-800/50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-orange-400">+${data.summary.cuYearChange}%</div>
                    <div class="text-xs text-gray-400">Cu ì—°ê°„</div>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-yellow-400">+${data.summary.snYearChange}%</div>
                    <div class="text-xs text-gray-400">Sn ì—°ê°„</div>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold text-blue-400">${data.summary.totalOrders}</div>
                    <div class="text-xs text-gray-400">ë¶„ì„ ê±´ìˆ˜</div>
                </div>
                <div class="bg-gray-800/50 rounded-lg p-3 text-center">
                    <div class="text-2xl font-bold ${ac.Good >= ac.Bad ? 'text-green-400' : 'text-red-400'}">${ac.Good >= ac.Bad ? 'Good' : 'Bad'}</div>
                    <div class="text-xs text-gray-400">ì „ì²´ íŒì •</div>
                </div>
            </div>

            <!-- ì°¨íŠ¸ -->
            <div class="bg-gray-800/30 rounded-lg p-4 mb-6">
                <canvas id="trendChart" height="200"></canvas>
            </div>

            <!-- ì›”ë³„ íŒì • -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-800/30 rounded-lg p-4">
                    <h4 class="font-medium mb-3 text-sm text-gray-400">ğŸ“Š ì›”ë³„ ì ì •ì„± íŒì •</h4>
                    <div class="grid grid-cols-3 gap-2 text-xs">
                        ${Object.entries(data.assessments).map(([m, v]) => {
                            const cls = v === 'Good' ? 'text-green-400' : (v === 'Bad' ? 'text-red-400' : 'text-yellow-400');
                            const emoji = v === 'Good' ? 'ğŸŸ¢' : (v === 'Bad' ? 'ğŸ”´' : 'ğŸŸ¡');
                            return `<div class="flex justify-between"><span>${m}ì›”</span><span class="${cls}">${emoji} ${v}</span></div>`;
                        }).join('')}
                    </div>
                </div>
                <div class="bg-gray-800/30 rounded-lg p-4">
                    <h4 class="font-medium mb-3 text-sm text-gray-400">ğŸ’¡ í•µì‹¬ ì¸ì‚¬ì´íŠ¸</h4>
                    <div class="text-xs text-gray-300 space-y-1">
                        <p>â€¢ ì‹œí™© +${data.summary.cuYearChange}%(Cu)/+${data.summary.snYearChange}%(Sn) ìƒìŠ¹ì—ë„ ë°œì£¼ë‹¨ê°€ ì•ˆì •</p>
                        <p>â€¢ ì‹œí™© ëŒ€ë¹„ ìœ ë¦¬í•œ êµ¬ë§¤ êµ¬ì¡° ìœ ì§€ ì¤‘ (Good ${ac.Good}ê°œì›”)</p>
                        <p>â€¢ ì›ì¬ë£Œ ë¹„ì¤‘ 80% ê°ì•ˆ ì‹œ, ì‹œí™© ë¯¸ë°˜ì˜ë¶„ ì†Œê¸‰ í˜‘ìƒ ì—¬ì§€</p>
                    </div>
                </div>
            </div>

            <div class="text-xs text-gray-600 mt-4">
                â€» ì§€ìˆ˜ ì‚°ì¶œ: 1ì›” ê¸°ì¤€ê°€ ëŒ€ë¹„ ë³€ë™ë¥ . Cu+Sn ê°€ì¤‘ì§€ìˆ˜ëŠ” Bronze í•©ê¸ˆë¹„ìœ¨(Cu88%+Sn12%) ì ìš©.
            </div>`;

            container.innerHTML = html;

            // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            setTimeout(() => drawTrendChart(data), 100);
        }

        function drawTrendChart(data) {
            const ctx = document.getElementById('trendChart')?.getContext('2d');
            if (!ctx) return;

            const months = data.trendData.map(d => d.month + 'ì›”');
            const cuSnData = data.trendData.map(d => d.cuSnIndex);
            
            // ë©”ì¸ ì—…ì²´ ë°ì´í„° (ì²« ë²ˆì§¸ ì—…ì²´)
            const mainVendor = data.summary.vendors[0];
            const vendorData = data.trendData.map(d => d.vendorIndices[mainVendor]);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Cu+Sn ê°€ì¤‘ì§€ìˆ˜',
                            data: cuSnData,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            borderWidth: 2.5,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: '#f59e0b',
                        },
                        {
                            label: mainVendor ? mainVendor.substring(0, 6) : 'ë°œì£¼ë‹¨ê°€',
                            data: vendorData,
                            borderColor: '#3b82f6',
                            borderWidth: 2.5,
                            tension: 0.3,
                            pointRadius: 4,
                            pointBackgroundColor: '#3b82f6',
                            spanGaps: true,
                        },
                        {
                            label: 'ê¸°ì¤€ì„  (100)',
                            data: Array(12).fill(100),
                            borderColor: 'rgba(255,255,255,0.15)',
                            borderWidth: 1,
                            borderDash: [2, 4],
                            pointRadius: 0,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: {
                            labels: { color: '#6b7a94', font: { size: 11 }, usePointStyle: true, padding: 16 }
                        },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleColor: '#e0e6f0',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                        }
                    },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(255,255,255,0.04)' }, 
                            ticks: { color: '#4b5e78', font: { size: 10 } } 
                        },
                        y: {
                            grid: { color: 'rgba(255,255,255,0.04)' },
                            ticks: { color: '#4b5e78', font: { size: 10 } },
                            min: 85, max: 145,
                            title: { display: true, text: 'ì§€ìˆ˜ (1ì›”=100)', color: '#4b5e78', font: { size: 10 } }
                        }
                    }
                }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Initialize
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();
                if (data.status === 'ok') {
                    document.getElementById('apiStatus').innerHTML = 
                        '<i class="fas fa-circle text-[8px] mr-1.5 text-green-400"></i>API ì—°ê²°ë¨';
                    document.getElementById('apiStatus').className = 
                        'px-3 py-1.5 bg-green-500/20 text-green-400 rounded-full text-xs font-medium';
                    document.getElementById('dataCount').textContent = 
                        `ë‹¨ê°€ ${data.data.priceTable} | ê²¬ì  ${data.data.quotes} | ì‹¤ì  ${data.data.orders.toLocaleString()} | BC ${data.data.bcOrders}`;
                }
            } catch {
                document.getElementById('apiStatus').innerHTML = 
                    '<i class="fas fa-exclamation-circle text-[8px] mr-1.5"></i>ì—°ê²° ì‹¤íŒ¨';
                document.getElementById('apiStatus').className = 
                    'px-3 py-1.5 bg-red-500/20 text-red-400 rounded-full text-xs font-medium';
            }
        });
    </script>
</body>
</html>
