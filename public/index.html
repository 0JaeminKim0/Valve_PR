<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valve Agent PoC - AI 단가 분석 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .slide-in { animation: slideIn 0.3s ease-out; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        .pulse { animation: pulse 1.5s ease-in-out infinite; }
        .typing-cursor::after {
            content: '|';
            animation: pulse 1s ease-in-out infinite;
        }
        .log-card {
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }
        .log-card.active {
            border-left-color: #3b82f6;
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%);
        }
        .log-card:hover {
            transform: translateX(4px);
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        .result-highlight {
            animation: highlight 2s ease-out;
        }
        @keyframes highlight {
            0% { background-color: rgba(59, 130, 246, 0.3); }
            100% { background-color: transparent; }
        }
        .status-excellent { color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .status-normal { color: #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .status-poor { color: #ef4444; background: rgba(239, 68, 68, 0.1); }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center">
                    <i class="fas fa-robot text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold">Valve Agent PoC</h1>
                    <p class="text-gray-400 text-sm">AI 기반 밸브 단가 분석 시스템</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <span id="apiStatus" class="px-3 py-1 bg-yellow-500/20 text-yellow-400 rounded-full text-sm">
                    <i class="fas fa-circle text-xs mr-1 pulse"></i> API 연결 확인 중...
                </span>
                <span class="text-gray-400 text-sm">
                    <i class="fas fa-database mr-1"></i>
                    <span id="dataCount">로딩...</span>
                </span>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="bg-gray-800/50 px-6 py-3 border-b border-gray-700">
        <div class="flex gap-2">
            <button onclick="switchTab(1)" class="tab-btn active px-6 py-2 rounded-lg font-medium transition-all" data-tab="1">
                <i class="fas fa-calculator mr-2"></i>화면1: 최적단가 제안
            </button>
            <button onclick="switchTab(2)" class="tab-btn px-6 py-2 rounded-lg font-medium transition-all bg-gray-700 hover:bg-gray-600" data-tab="2">
                <i class="fas fa-check-circle mr-2"></i>화면2: 견적 검증
            </button>
            <button onclick="switchTab(3)" class="tab-btn px-6 py-2 rounded-lg font-medium transition-all bg-gray-700 hover:bg-gray-600" data-tab="3">
                <i class="fas fa-chart-line mr-2"></i>화면3: 시황 분석
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex h-[calc(100vh-140px)]">
        <!-- Left Panel: Agent Logs (40%) -->
        <div class="w-2/5 border-r border-gray-700 flex flex-col">
            <div class="p-4 border-b border-gray-700 bg-gray-800/30">
                <div class="flex items-center justify-between">
                    <h2 class="font-semibold flex items-center gap-2">
                        <i class="fas fa-terminal text-blue-400"></i>
                        Agent 분석 로그
                    </h2>
                    <button onclick="clearLogs()" class="text-gray-400 hover:text-white text-sm">
                        <i class="fas fa-trash-alt mr-1"></i>초기화
                    </button>
                </div>
            </div>
            <div id="agentLogs" class="flex-1 overflow-y-auto p-4 space-y-3">
                <div class="text-gray-500 text-center py-8">
                    <i class="fas fa-robot text-4xl mb-3 opacity-30"></i>
                    <p>분석을 시작하면 Agent 로그가 여기에 표시됩니다</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Results (60%) -->
        <div class="w-3/5 flex flex-col">
            <!-- Tab 1: 최적단가 제안 -->
            <div id="tab1" class="tab-content flex-1 overflow-y-auto">
                <div class="p-6">
                    <div class="bg-gray-800 rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i class="fas fa-search text-blue-400"></i>
                            PR 자재 검색
                        </h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">밸브 타입</label>
                                <select id="valveTypeSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                                    <option value="">밸브 타입 선택...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">수량 (개)</label>
                                <input type="number" id="quantityInput" value="10" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                            </div>
                        </div>
                        <button onclick="analyzePriceRecommendation()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 py-3 rounded-lg font-medium transition-all">
                            <i class="fas fa-play mr-2"></i>최적 단가 분석 시작
                        </button>
                    </div>

                    <div id="priceResult" class="hidden">
                        <!-- 결과가 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>

            <!-- Tab 2: 견적 검증 -->
            <div id="tab2" class="tab-content hidden flex-1 overflow-y-auto">
                <div class="p-6">
                    <div class="bg-gray-800 rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i class="fas fa-file-invoice text-green-400"></i>
                            협력사 견적 검증
                        </h3>
                        <div class="mb-4">
                            <label class="block text-sm text-gray-400 mb-1">견적 선택</label>
                            <select id="quoteSelect" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                                <option value="">견적 항목 선택...</option>
                            </select>
                        </div>
                        <button onclick="analyzeQuoteVerification()" class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 py-3 rounded-lg font-medium transition-all">
                            <i class="fas fa-check-double mr-2"></i>견적 적정성 검증 시작
                        </button>
                    </div>

                    <div id="quoteResult" class="hidden">
                        <!-- 결과가 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>

            <!-- Tab 3: 시황 분석 -->
            <div id="tab3" class="tab-content hidden flex-1 overflow-y-auto">
                <div class="p-6">
                    <div class="bg-gray-800 rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i class="fas fa-globe text-purple-400"></i>
                            원재료 시황 분석
                        </h3>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">분석 대상</label>
                                <select id="marketAnalysisTarget" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                                    <option value="VGBARR240AT">VGBARR240AT (BC밸브, 654건)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">분석 기간</label>
                                <select id="analysisPeriod" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                                    <option value="2025">2025년</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="analyzeMarketTrend()" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 py-3 rounded-lg font-medium transition-all">
                            <i class="fas fa-chart-area mr-2"></i>시황 트렌드 분석 시작
                        </button>
                    </div>

                    <div id="marketResult" class="hidden">
                        <!-- 결과가 여기에 표시됩니다 -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global State
        let currentTab = 1;
        let priceTableData = [];
        let quotesData = [];
        let ordersData = [];
        let lmeData = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkApiStatus();
            await loadInitialData();
        });

        // API Status Check
        async function checkApiStatus() {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();
                if (data.status === 'ok') {
                    document.getElementById('apiStatus').innerHTML = 
                        '<i class="fas fa-circle text-xs mr-1 text-green-400"></i> API 연결됨';
                    document.getElementById('apiStatus').className = 
                        'px-3 py-1 bg-green-500/20 text-green-400 rounded-full text-sm';
                    document.getElementById('dataCount').textContent = 
                        `단가 ${data.data.priceTable}건 | 견적 ${data.data.quotes}건 | 실적 ${data.data.orders}건`;
                }
            } catch (e) {
                document.getElementById('apiStatus').innerHTML = 
                    '<i class="fas fa-exclamation-circle text-xs mr-1"></i> API 연결 실패';
                document.getElementById('apiStatus').className = 
                    'px-3 py-1 bg-red-500/20 text-red-400 rounded-full text-sm';
            }
        }

        // Load Initial Data
        async function loadInitialData() {
            try {
                // Load valve types for dropdown
                const priceRes = await fetch('/api/price-table');
                const priceData = await priceRes.json();
                priceTableData = priceData.data || [];
                
                const valveSelect = document.getElementById('valveTypeSelect');
                const uniqueTypes = [...new Set(priceTableData.map(p => p['밸브타입']))];
                uniqueTypes.forEach(type => {
                    const opt = document.createElement('option');
                    opt.value = type;
                    opt.textContent = type;
                    valveSelect.appendChild(opt);
                });

                // Load quotes for dropdown
                const quoteRes = await fetch('/api/quotes');
                const quoteData = await quoteRes.json();
                quotesData = quoteData.data || [];
                
                const quoteSelect = document.getElementById('quoteSelect');
                quotesData.slice(0, 50).forEach((q, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.textContent = `${q['자재번호']} - ${q['자재내역']?.substring(0, 30)}...`;
                    quoteSelect.appendChild(opt);
                });

            } catch (e) {
                console.error('Data load error:', e);
            }
        }

        // Tab Switching
        function switchTab(tabNum) {
            currentTab = tabNum;
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
            });
            document.querySelector(`[data-tab="${tabNum}"]`).classList.add('active');
            document.querySelector(`[data-tab="${tabNum}"]`).classList.remove('bg-gray-700', 'hover:bg-gray-600');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(`tab${tabNum}`).classList.remove('hidden');
        }

        // Clear Logs
        function clearLogs() {
            document.getElementById('agentLogs').innerHTML = `
                <div class="text-gray-500 text-center py-8">
                    <i class="fas fa-robot text-4xl mb-3 opacity-30"></i>
                    <p>분석을 시작하면 Agent 로그가 여기에 표시됩니다</p>
                </div>
            `;
        }

        // Add Log Entry with Animation
        function addLog(step, icon, title, content, status = 'processing') {
            const logsContainer = document.getElementById('agentLogs');
            if (logsContainer.querySelector('.text-gray-500.text-center')) {
                logsContainer.innerHTML = '';
            }

            const logId = `log-${Date.now()}`;
            const statusIcon = status === 'processing' 
                ? '<div class="spinner"></div>' 
                : status === 'complete' 
                    ? '<i class="fas fa-check text-green-400"></i>'
                    : '<i class="fas fa-times text-red-400"></i>';

            const logHtml = `
                <div id="${logId}" class="log-card bg-gray-800 rounded-lg p-4 slide-in active">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 bg-blue-500/20 rounded-lg flex items-center justify-center flex-shrink-0">
                            <i class="fas ${icon} text-blue-400 text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-medium text-sm">${step}. ${title}</span>
                                <span id="${logId}-status">${statusIcon}</span>
                            </div>
                            <p id="${logId}-content" class="text-gray-400 text-sm typing-cursor">${content}</p>
                        </div>
                    </div>
                </div>
            `;

            logsContainer.insertAdjacentHTML('beforeend', logHtml);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // Remove active state from previous logs
            setTimeout(() => {
                document.querySelectorAll('.log-card.active').forEach(card => {
                    if (card.id !== logId) card.classList.remove('active');
                });
            }, 100);

            return logId;
        }

        // Update Log Status
        function updateLogStatus(logId, status, newContent = null) {
            const statusEl = document.getElementById(`${logId}-status`);
            const contentEl = document.getElementById(`${logId}-content`);
            
            if (statusEl) {
                statusEl.innerHTML = status === 'complete' 
                    ? '<i class="fas fa-check text-green-400"></i>'
                    : '<i class="fas fa-times text-red-400"></i>';
            }
            
            if (contentEl && newContent) {
                contentEl.classList.remove('typing-cursor');
                typeText(contentEl, newContent);
            } else if (contentEl) {
                contentEl.classList.remove('typing-cursor');
            }
        }

        // Typing Effect
        async function typeText(element, text, delay = 20) {
            element.textContent = '';
            for (let i = 0; i < text.length; i++) {
                element.textContent += text[i];
                await new Promise(r => setTimeout(r, delay));
            }
        }

        // Format Currency
        function formatCurrency(num) {
            if (num === null || num === undefined || isNaN(num)) return '-';
            return Math.round(num).toLocaleString('ko-KR') + '원';
        }

        // ========== Tab 1: 최적단가 분석 ==========
        async function analyzePriceRecommendation() {
            const valveType = document.getElementById('valveTypeSelect').value;
            const quantity = parseInt(document.getElementById('quantityInput').value) || 10;

            if (!valveType) {
                alert('밸브 타입을 선택해주세요.');
                return;
            }

            clearLogs();
            document.getElementById('priceResult').classList.add('hidden');

            // Step 1: 데이터 수집
            const log1 = addLog(1, 'fa-database', '데이터 수집', '단가 테이블 및 발주 실적 조회 중...');
            await new Promise(r => setTimeout(r, 800));
            updateLogStatus(log1, 'complete', `밸브타입 ${valveType} 관련 데이터 수집 완료`);

            // Step 2: 규칙 적용
            const log2 = addLog(2, 'fa-cogs', '매핑 규칙 적용', 'Rule 1~3 적용하여 단가 계산 중...');
            await new Promise(r => setTimeout(r, 600));
            updateLogStatus(log2, 'complete', 'BODY2 기본단가 + 옵션단가 계산 완료');

            // Step 3: API 호출
            const log3 = addLog(3, 'fa-brain', 'AI 분석', 'Claude API로 최적 단가 분석 중...');
            
            try {
                const response = await fetch('/api/analyze/price-recommendation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ valveType, quantity })
                });

                const result = await response.json();
                
                if (result.success) {
                    updateLogStatus(log3, 'complete', 'AI 분석 완료');
                    
                    // Step 4: 결과 정리
                    const log4 = addLog(4, 'fa-check-double', '결과 도출', '최적 단가 및 근거 정리 중...');
                    await new Promise(r => setTimeout(r, 500));
                    updateLogStatus(log4, 'complete', '분석 결과 도출 완료');

                    displayPriceResult(result.data);
                } else {
                    updateLogStatus(log3, 'error', result.error || '분석 실패');
                }
            } catch (e) {
                updateLogStatus(log3, 'error', '서버 연결 오류');
            }
        }

        function displayPriceResult(data) {
            const resultDiv = document.getElementById('priceResult');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 fade-in">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-lightbulb text-yellow-400"></i>
                        최적 단가 제안 결과
                    </h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-700/50 rounded-lg p-4">
                            <div class="text-gray-400 text-sm mb-1">밸브 타입</div>
                            <div class="text-xl font-bold">${data.valveType || '-'}</div>
                        </div>
                        <div class="bg-gray-700/50 rounded-lg p-4">
                            <div class="text-gray-400 text-sm mb-1">요청 수량</div>
                            <div class="text-xl font-bold">${data.quantity || '-'}개</div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-lg p-4 mb-6">
                        <div class="text-gray-300 text-sm mb-2">추천 단가</div>
                        <div class="text-3xl font-bold text-blue-400">${formatCurrency(data.recommendedPrice)}</div>
                        <div class="text-gray-400 text-sm mt-1">KG당: ${formatCurrency(data.pricePerKg)}</div>
                    </div>

                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-gray-400">BODY2 기본단가</span>
                            <span class="font-medium">${formatCurrency(data.bodyPrice)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-gray-400">옵션 단가 합계</span>
                            <span class="font-medium">${formatCurrency(data.optionPrice)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-gray-400">최근 발주 평균단가</span>
                            <span class="font-medium">${formatCurrency(data.recentOrderAvg)}</span>
                        </div>
                    </div>

                    ${data.aiAnalysis ? `
                    <div class="mt-6 bg-gray-700/30 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-robot text-blue-400"></i>
                            <span class="font-medium">AI 분석 의견</span>
                        </div>
                        <p class="text-gray-300 text-sm leading-relaxed">${data.aiAnalysis}</p>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // ========== Tab 2: 견적 검증 ==========
        async function analyzeQuoteVerification() {
            const quoteIdx = document.getElementById('quoteSelect').value;
            
            if (quoteIdx === '') {
                alert('견적 항목을 선택해주세요.');
                return;
            }

            clearLogs();
            document.getElementById('quoteResult').classList.add('hidden');

            const quote = quotesData[parseInt(quoteIdx)];

            // Step 1: 견적 데이터 로드
            const log1 = addLog(1, 'fa-file-alt', '견적 데이터 로드', '협력사 제출 견적 정보 확인 중...');
            await new Promise(r => setTimeout(r, 600));
            updateLogStatus(log1, 'complete', `자재번호: ${quote['자재번호']} 로드 완료`);

            // Step 2: 매핑 규칙 적용
            const log2 = addLog(2, 'fa-link', '밸브타입 매핑', '자재번호 → 밸브타입 매핑 중...');
            await new Promise(r => setTimeout(r, 500));
            updateLogStatus(log2, 'complete', '매핑 규칙 적용 완료');

            // Step 3: 발주 실적 조회
            const log3 = addLog(3, 'fa-history', '발주 실적 조회', '과거 발주 내역 분석 중...');
            await new Promise(r => setTimeout(r, 700));

            // Step 4: AI 분석
            const log4 = addLog(4, 'fa-brain', 'AI 적정성 검증', 'Claude API로 견적 적정성 분석 중...');

            try {
                const response = await fetch('/api/analyze/quote-verification', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quoteIndex: parseInt(quoteIdx) })
                });

                const result = await response.json();
                
                if (result.success) {
                    updateLogStatus(log3, 'complete', `관련 발주실적 ${result.data.relatedOrders || 0}건 확인`);
                    updateLogStatus(log4, 'complete', 'AI 분석 완료');
                    
                    const log5 = addLog(5, 'fa-gavel', '판정 결과', '최종 적정성 판정 중...');
                    await new Promise(r => setTimeout(r, 400));
                    updateLogStatus(log5, 'complete', `판정: ${result.data.verdict || '분석 완료'}`);

                    displayQuoteResult(result.data);
                } else {
                    updateLogStatus(log4, 'error', result.error || '검증 실패');
                }
            } catch (e) {
                updateLogStatus(log4, 'error', '서버 연결 오류');
            }
        }

        function displayQuoteResult(data) {
            const resultDiv = document.getElementById('quoteResult');
            resultDiv.classList.remove('hidden');
            
            const verdictClass = data.verdict === '우수' ? 'status-excellent' 
                : data.verdict === '보통' ? 'status-normal' 
                : 'status-poor';

            resultDiv.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 fade-in">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-clipboard-check text-green-400"></i>
                        견적 검증 결과
                    </h3>

                    <div class="flex items-center justify-center mb-6">
                        <div class="text-center">
                            <div class="w-24 h-24 rounded-full flex items-center justify-center ${verdictClass} mb-2">
                                <span class="text-3xl font-bold">${data.verdict || '-'}</span>
                            </div>
                            <div class="text-gray-400 text-sm">적정성 판정</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-700/50 rounded-lg p-4">
                            <div class="text-gray-400 text-sm mb-1">자재번호</div>
                            <div class="font-bold truncate">${data.materialNo || '-'}</div>
                        </div>
                        <div class="bg-gray-700/50 rounded-lg p-4">
                            <div class="text-gray-400 text-sm mb-1">매핑된 밸브타입</div>
                            <div class="font-bold">${data.valveType || '-'}</div>
                        </div>
                    </div>

                    <div class="space-y-3 mb-6">
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-gray-400">협력사 견적단가</span>
                            <span class="font-medium text-yellow-400">${formatCurrency(data.quotePrice)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-gray-400">시스템 추천단가</span>
                            <span class="font-medium text-blue-400">${formatCurrency(data.systemPrice)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-gray-400">최근 발주단가</span>
                            <span class="font-medium">${formatCurrency(data.recentOrderPrice)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-gray-400">발주단가×90%</span>
                            <span class="font-medium">${formatCurrency(data.targetPrice)}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-b border-gray-700">
                            <span class="text-gray-400">괴리율</span>
                            <span class="font-medium ${data.diffRate > 0 ? 'text-red-400' : 'text-green-400'}">${data.diffRate?.toFixed(1) || '-'}%</span>
                        </div>
                    </div>

                    ${data.aiAnalysis ? `
                    <div class="bg-gray-700/30 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-robot text-green-400"></i>
                            <span class="font-medium">AI 협상 전략 제안</span>
                        </div>
                        <p class="text-gray-300 text-sm leading-relaxed">${data.aiAnalysis}</p>
                    </div>
                    ` : ''}
                </div>
            `;
        }

        // ========== Tab 3: 시황 분석 ==========
        async function analyzeMarketTrend() {
            const target = document.getElementById('marketAnalysisTarget').value;
            
            clearLogs();
            document.getElementById('marketResult').classList.add('hidden');

            // Step 1: LME 시황 조회
            const log1 = addLog(1, 'fa-globe', 'LME 시황 조회', '2025년 Cu/Sn 월별 시황 데이터 로드 중...');
            await new Promise(r => setTimeout(r, 800));
            updateLogStatus(log1, 'complete', 'LME 월별 시황 데이터 12개월 로드 완료');

            // Step 2: 발주 실적 분석
            const log2 = addLog(2, 'fa-chart-bar', '발주 실적 분석', `${target} 타입 발주 실적 집계 중...`);
            await new Promise(r => setTimeout(r, 600));
            updateLogStatus(log2, 'complete', `${target} 타입 654건 발주 실적 분석 완료`);

            // Step 3: 지수 계산
            const log3 = addLog(3, 'fa-calculator', '시황 지수 산출', 'Cu 88% + Sn 12% 가중지수 계산 중...');
            await new Promise(r => setTimeout(r, 500));

            // Step 4: AI 분석
            const log4 = addLog(4, 'fa-brain', 'AI 트렌드 분석', 'Claude API로 시황-단가 상관관계 분석 중...');

            try {
                const response = await fetch('/api/analyze/market-trend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ valveType: target })
                });

                const result = await response.json();
                
                if (result.success) {
                    updateLogStatus(log3, 'complete', 'Cu+Sn 가중지수 계산 완료');
                    updateLogStatus(log4, 'complete', 'AI 트렌드 분석 완료');

                    const log5 = addLog(5, 'fa-flag-checkered', '적정성 판정', '월별 가격 적정성 판정 중...');
                    await new Promise(r => setTimeout(r, 400));
                    updateLogStatus(log5, 'complete', '월별 적정성 판정 완료');

                    displayMarketResult(result.data);
                } else {
                    updateLogStatus(log4, 'error', result.error || '분석 실패');
                }
            } catch (e) {
                updateLogStatus(log4, 'error', '서버 연결 오류');
            }
        }

        function displayMarketResult(data) {
            const resultDiv = document.getElementById('marketResult');
            resultDiv.classList.remove('hidden');

            const months = data.monthlyData?.map(d => d.month) || ['1월','2월','3월','4월','5월','6월','7월','8월','9월','10월','11월','12월'];
            const cuSnIndex = data.monthlyData?.map(d => d.cuSnIndex) || [];
            const orderIndex = data.monthlyData?.map(d => d.orderIndex) || [];

            resultDiv.innerHTML = `
                <div class="bg-gray-800 rounded-xl p-6 fade-in">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-line text-purple-400"></i>
                        시황 × 발주단가 트렌드 분석
                    </h3>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                            <div class="text-gray-400 text-sm mb-1">분석 대상</div>
                            <div class="text-xl font-bold text-purple-400">${data.valveType || 'VGBARR240AT'}</div>
                        </div>
                        <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                            <div class="text-gray-400 text-sm mb-1">분석 건수</div>
                            <div class="text-xl font-bold">${data.totalOrders || 654}건</div>
                        </div>
                        <div class="bg-gray-700/50 rounded-lg p-4 text-center">
                            <div class="text-gray-400 text-sm mb-1">전체 적정성</div>
                            <div class="text-xl font-bold ${data.overallAssessment === 'Good' ? 'text-green-400' : data.overallAssessment === 'Normal' ? 'text-yellow-400' : 'text-red-400'}">${data.overallAssessment || 'Normal'}</div>
                        </div>
                    </div>

                    <div class="bg-gray-700/30 rounded-lg p-4 mb-6">
                        <canvas id="trendChart" height="200"></canvas>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <h4 class="font-medium mb-3 text-sm">Cu/Sn 시황지수 (1월=100)</h4>
                            <div class="text-2xl font-bold text-orange-400">${cuSnIndex[cuSnIndex.length-1]?.toFixed(1) || '-'}</div>
                            <div class="text-gray-400 text-sm">12월 기준</div>
                        </div>
                        <div class="bg-gray-700/30 rounded-lg p-4">
                            <h4 class="font-medium mb-3 text-sm">발주단가지수 (1월=100)</h4>
                            <div class="text-2xl font-bold text-blue-400">${orderIndex[orderIndex.length-1]?.toFixed(1) || '-'}</div>
                            <div class="text-gray-400 text-sm">12월 기준</div>
                        </div>
                    </div>

                    ${data.aiAnalysis ? `
                    <div class="bg-gray-700/30 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-robot text-purple-400"></i>
                            <span class="font-medium">AI 시황 분석 의견</span>
                        </div>
                        <p class="text-gray-300 text-sm leading-relaxed">${data.aiAnalysis}</p>
                    </div>
                    ` : ''}
                </div>
            `;

            // Draw Chart
            setTimeout(() => {
                const ctx = document.getElementById('trendChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Cu+Sn 시황지수',
                                data: cuSnIndex,
                                borderColor: '#f97316',
                                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: '발주단가지수',
                                data: orderIndex,
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                fill: true,
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#9ca3af' }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(75, 85, 99, 0.3)' }
                            },
                            y: {
                                ticks: { color: '#9ca3af' },
                                grid: { color: 'rgba(75, 85, 99, 0.3)' }
                            }
                        }
                    }
                });
            }, 100);
        }
    </script>
</body>
</html>
