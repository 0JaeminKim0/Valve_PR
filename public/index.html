<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>밸브재 구매 AI Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        * { font-family: 'Noto Sans KR', sans-serif; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* ═══════════════════════════════════════════════════════ */
        /* PRD v2.0 Animations                                      */
        /* ═══════════════════════════════════════════════════════ */
        @keyframes slideInLeft { 
            from { opacity: 0; transform: translateX(-30px); } 
            to { opacity: 1; transform: translateX(0); } 
        }
        @keyframes slideInUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes gradientMove { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }
        
        .slide-in-left { animation: slideInLeft 0.4s ease-out forwards; }
        .slide-in-up { animation: slideInUp 0.4s ease-out forwards; }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .pulse { animation: pulse 1.5s ease-in-out infinite; }
        
        /* ═══════════════════════════════════════════════════════ */
        /* PRD v2.0 Agent Cards (색상별 분류)                       */
        /* ═══════════════════════════════════════════════════════ */
        .agent-card {
            border-radius: 12px;
            padding: 14px 18px;
            margin-bottom: 14px;
            background: rgba(30, 41, 59, 0.6);
            border-left: 4px solid;
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
        }
        .agent-card:hover { transform: translateX(4px); }
        
        /* 데이터 수집: 파란색 */
        .agent-card.data { 
            border-color: #3b82f6; 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(30, 41, 59, 0.6) 100%);
        }
        .agent-card.data .card-icon { color: #60a5fa; }
        
        /* Rule 적용: 보라색 */
        .agent-card.rule { 
            border-color: #8b5cf6; 
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(30, 41, 59, 0.6) 100%);
        }
        .agent-card.rule .card-icon { color: #a78bfa; }
        
        /* 웹검색: 초록색 */
        .agent-card.search { 
            border-color: #10b981; 
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(30, 41, 59, 0.6) 100%);
        }
        .agent-card.search .card-icon { color: #34d399; }
        
        /* LLM 분석: 주황색 */
        .agent-card.llm { 
            border-color: #f59e0b; 
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(30, 41, 59, 0.6) 100%);
        }
        .agent-card.llm .card-icon { color: #fbbf24; }
        
        /* 판정 결과: 색상별 */
        .agent-card.result-good { border-color: #10b981; background: rgba(16, 185, 129, 0.15); }
        .agent-card.result-normal { border-color: #f59e0b; background: rgba(245, 158, 11, 0.15); }
        .agent-card.result-bad { border-color: #ef4444; background: rgba(239, 68, 68, 0.15); }
        
        /* Collapsed 상태 (완료된 단계) */
        .agent-card.collapsed {
            padding: 10px 16px;
            margin-bottom: 8px;
            opacity: 0.7;
            cursor: pointer;
        }
        .agent-card.collapsed:hover { opacity: 1; }
        .agent-card.collapsed .card-content { display: none; }
        
        /* ═══════════════════════════════════════════════════════ */
        /* 타이핑 효과 (PRD: LLM 스트리밍)                           */
        /* ═══════════════════════════════════════════════════════ */
        .typing-cursor::after {
            content: '▌';
            animation: blink 0.7s infinite;
            color: #f59e0b;
            margin-left: 2px;
        }
        
        /* 스피너 */
        .spinner {
            border: 2px solid rgba(255,255,255,0.1);
            border-top: 2px solid currentColor;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 0.8s linear infinite;
            display: inline-block;
        }
        .spinner-lg { width: 24px; height: 24px; border-width: 3px; }
        
        /* ═══════════════════════════════════════════════════════ */
        /* 진행률 바 (PRD: 상단 Progress)                            */
        /* ═══════════════════════════════════════════════════════ */
        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        .progress-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6, #ec4899);
            background-size: 200% 100%;
            animation: gradientMove 3s ease infinite;
            transition: width 0.5s ease;
        }
        
        /* ═══════════════════════════════════════════════════════ */
        /* 탭 버튼                                                   */
        /* ═══════════════════════════════════════════════════════ */
        .tab-btn {
            position: relative;
            overflow: hidden;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        }
        .tab-btn.active::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: gradientMove 2s ease infinite;
        }
        
        /* ═══════════════════════════════════════════════════════ */
        /* PRD v2.0 테이블 스타일                                    */
        /* ═══════════════════════════════════════════════════════ */
        .prd-table {
            font-size: 11px;
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }
        .prd-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .prd-table th {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0;
            font-weight: 600;
            padding: 12px 10px;
            text-align: center;
            border: 1px solid #334155;
            white-space: nowrap;
        }
        .prd-table th.section-header {
            background: linear-gradient(135deg, #1e40af 0%, #3730a3 100%);
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .prd-table td {
            padding: 12px 10px;
            border: 1px solid #334155;
            text-align: center;
            vertical-align: middle;
            background: rgba(15, 23, 42, 0.4);
        }
        .prd-table tr:nth-child(even) td { background: rgba(30, 41, 59, 0.4); }
        .prd-table tr:hover td { background: rgba(59, 130, 246, 0.15) !important; cursor: pointer; }
        .prd-table tr.expanded td { background: rgba(139, 92, 246, 0.2) !important; }
        .prd-table .text-left { text-align: left; }
        .prd-table .text-right { text-align: right; }
        .prd-table .price { font-family: 'JetBrains Mono', monospace; font-weight: 500; font-size: 11px; }
        .prd-table .highlight { background: rgba(251, 191, 36, 0.2) !important; }
        .prd-table .recommend { background: rgba(34, 197, 94, 0.2) !important; color: #4ade80; font-weight: 700; }
        
        /* 상세 펼침 패널 (PRD: 행 클릭 확장) */
        .detail-panel {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.9) 0%, rgba(15, 23, 42, 0.95) 100%);
            border: 1px solid rgba(139, 92, 246, 0.4);
            border-radius: 12px;
            padding: 20px;
            margin: 12px 8px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        /* ═══════════════════════════════════════════════════════ */
        /* 배지                                                     */
        /* ═══════════════════════════════════════════════════════ */
        .badge { 
            padding: 5px 12px; 
            border-radius: 20px; 
            font-size: 11px; 
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .badge-good { background: rgba(16, 185, 129, 0.25); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.4); }
        .badge-normal { background: rgba(245, 158, 11, 0.25); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.4); }
        .badge-bad { background: rgba(239, 68, 68, 0.25); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.4); }
        .badge-info { background: rgba(59, 130, 246, 0.25); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.4); }
        
        /* ═══════════════════════════════════════════════════════ */
        /* KPI 카드                                                 */
        /* ═══════════════════════════════════════════════════════ */
        .kpi-card {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.9) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.3);
            border-color: rgba(255,255,255,0.2);
        }
        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            line-height: 1.2;
        }
        
        /* ═══════════════════════════════════════════════════════ */
        /* 스크롤바                                                 */
        /* ═══════════════════════════════════════════════════════ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }
        
        /* ═══════════════════════════════════════════════════════ */
        /* 차트 컨테이너                                             */
        /* ═══════════════════════════════════════════════════════ */
        .chart-container {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.5) 0%, rgba(15, 23, 42, 0.7) 100%);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 20px;
        }
        
        /* 적정성 타임라인 */
        .timeline-dot {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .timeline-dot:hover { transform: scale(1.15); }
        .timeline-dot.good { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .timeline-dot.normal { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .timeline-dot.bad { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-900 via-slate-900 to-gray-900 text-white min-h-screen">
    <!-- ═══════════════════════════════════════════════════════ -->
    <!-- Header (PRD: 상단 Progress Bar 포함)                     -->
    <!-- ═══════════════════════════════════════════════════════ -->
    <header class="bg-gray-800/70 backdrop-blur-xl border-b border-gray-700/50 px-6 py-4 sticky top-0 z-50">
        <div class="max-w-[1920px] mx-auto">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 rounded-2xl flex items-center justify-center shadow-lg shadow-purple-500/30">
                        <i class="fas fa-robot text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
                            밸브재 구매 AI Agent
                        </h1>
                        <p class="text-gray-400 text-xs">구매 의사결정 지원 시스템</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="startDemo()" id="demoBtn" class="px-6 py-2.5 bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 hover:from-blue-700 hover:via-purple-700 hover:to-pink-700 rounded-xl text-sm font-semibold transition-all shadow-lg shadow-purple-500/30 flex items-center gap-2">
                        <i class="fas fa-play"></i>
                        <span>분석 실행</span>
                    </button>
                    <span id="apiStatus" class="px-4 py-2 bg-yellow-500/20 text-yellow-400 rounded-full text-xs font-medium flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-current pulse"></span>
                        연결 확인 중...
                    </span>
                </div>
            </div>
            <!-- PRD: 상단 Progress Bar -->
            <div class="progress-bar">
                <div id="progressFill" class="fill" style="width: 0%"></div>
            </div>
            <div class="flex justify-between mt-2 text-xs text-gray-500">
                <span id="progressStep">대기 중</span>
                <span id="progressPercent">0%</span>
            </div>
        </div>
    </header>

    <!-- ═══════════════════════════════════════════════════════ -->
    <!-- Tab Navigation                                          -->
    <!-- ═══════════════════════════════════════════════════════ -->
    <nav class="bg-gray-800/40 backdrop-blur px-6 py-3 border-b border-gray-700/50">
        <div class="flex gap-3 max-w-[1920px] mx-auto">
            <button onclick="switchTab(1)" class="tab-btn active px-6 py-3 rounded-xl text-sm font-semibold transition-all flex items-center gap-2" data-tab="1">
                <i class="fas fa-calculator"></i>
                PR 최적단가 제안
            </button>
            <button onclick="switchTab(2)" class="tab-btn px-6 py-3 rounded-xl text-sm font-semibold transition-all bg-gray-700/50 hover:bg-gray-700 flex items-center gap-2" data-tab="2">
                <i class="fas fa-clipboard-check"></i>
                협력사 견적 검증
            </button>
            <button onclick="switchTab(3)" class="tab-btn px-6 py-3 rounded-xl text-sm font-semibold transition-all bg-gray-700/50 hover:bg-gray-700 flex items-center gap-2" data-tab="3">
                <i class="fas fa-chart-line"></i>
                원재료 시황 분석
            </button>
        </div>
    </nav>

    <!-- ═══════════════════════════════════════════════════════ -->
    <!-- Main Content: PRD v2.0 좌40% Agent + 우60% 결과         -->
    <!-- ═══════════════════════════════════════════════════════ -->
    <main class="flex h-[calc(100vh-155px)] max-w-[1920px] mx-auto">
        <!-- Left Panel: Agent 스트리밍 패널 (40%) -->
        <div class="w-[40%] border-r border-gray-700/50 flex flex-col bg-gradient-to-b from-gray-900/50 to-slate-900/50">
            <div class="p-4 border-b border-gray-700/50 bg-gray-800/30">
                <div class="flex items-center justify-between">
                    <h2 class="font-semibold text-sm flex items-center gap-2">
                        <i class="fas fa-brain text-purple-400"></i>
                        Agent 분석 과정
                    </h2>
                    <div class="flex items-center gap-3">
                        <span id="stepCount" class="text-xs text-gray-500">0 / 0 단계</span>
                        <button onclick="collapseCompleted()" class="text-xs text-gray-400 hover:text-white transition-colors" title="완료 단계 접기">
                            <i class="fas fa-compress-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div id="agentPanel" class="flex-1 overflow-y-auto p-4 bg-gradient-to-b from-transparent to-gray-950/30">
                <div class="text-center py-20 text-gray-500">
                    <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-gray-800/50 flex items-center justify-center">
                        <i class="fas fa-robot text-4xl opacity-30"></i>
                    </div>
                    <p class="text-sm font-medium">"분석 실행" 버튼을 클릭하면</p>
                    <p class="text-sm">AI Agent가 분석을 시작합니다</p>
                    <div class="mt-4 text-xs text-gray-600">
                        <p>데이터 조회 → 단가 산출 → AI 분석 → 추천</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel: 결과 패널 (60%) -->
        <div class="w-[60%] flex flex-col bg-gradient-to-b from-gray-900/30 to-slate-900/30">
            <!-- Tab 1: PR 최적단가 제안 -->
            <div id="tab1" class="tab-content flex-1 overflow-auto p-5">
                <div id="screen1-intro" class="text-center py-20 text-gray-500">
                    <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-gray-800/50 flex items-center justify-center">
                        <i class="fas fa-file-invoice-dollar text-4xl opacity-30"></i>
                    </div>
                    <p class="text-sm font-medium">PR 건별 최적 추천 단가 분석 결과</p>
                    <p class="text-xs mt-2 text-gray-600">단가테이블 기반 계약단가 + 과거 발주실적 기반 예상단가</p>
                    <div class="mt-6 grid grid-cols-3 gap-4 max-w-md mx-auto text-xs">
                        <div class="p-3 rounded-lg bg-blue-500/10 border border-blue-500/20">
                            <div class="text-blue-400 font-semibold">기본단가</div>
                            <div class="text-gray-500">BODY2</div>
                        </div>
                        <div class="p-3 rounded-lg bg-purple-500/10 border border-purple-500/20">
                            <div class="text-purple-400 font-semibold">옵션단가</div>
                            <div class="text-gray-500">I/O-P, LOCK 등</div>
                        </div>
                        <div class="p-3 rounded-lg bg-green-500/10 border border-green-500/20">
                            <div class="text-green-400 font-semibold">계약단가</div>
                            <div class="text-gray-500">합계</div>
                        </div>
                    </div>
                </div>
                <div id="screen1-results" class="hidden"></div>
            </div>

            <!-- Tab 2: 견적 검증 -->
            <div id="tab2" class="tab-content hidden flex-1 overflow-auto p-5">
                <div id="screen2-intro" class="text-center py-20 text-gray-500">
                    <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-gray-800/50 flex items-center justify-center">
                        <i class="fas fa-clipboard-check text-4xl opacity-30"></i>
                    </div>
                    <p class="text-sm font-medium">협력사 견적 적정성 검증 결과</p>
                    <p class="text-xs mt-2 text-gray-600">발주실적 대비 견적가 적정성 분석</p>
                </div>
                <div id="screen2-results" class="hidden"></div>
            </div>

            <!-- Tab 3: 시황 분석 -->
            <div id="tab3" class="tab-content hidden flex-1 overflow-auto p-5">
                <div id="screen3-intro" class="text-center py-20 text-gray-500">
                    <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-gray-800/50 flex items-center justify-center">
                        <i class="fas fa-globe text-4xl opacity-30"></i>
                    </div>
                    <p class="text-sm font-medium">원재료 시황 × 발주단가 종합 분석</p>
                    <p class="text-xs mt-2 text-gray-600">LME Cu/Sn 시황 vs 업체별 발주단가 트렌드</p>
                </div>
                <div id="screen3-results" class="hidden"></div>
            </div>
        </div>
    </main>

    <script>
        // ═══════════════════════════════════════════════════════════════
        //  PRD v2.0 Global State
        // ═══════════════════════════════════════════════════════════════
        let currentTab = 1;
        let isRunning = false;
        let currentStep = 0;
        let totalSteps = 0;
        let expandedRow = null;
        let chartInstances = {};

        // ═══════════════════════════════════════════════════════════════
        //  Utility Functions
        // ═══════════════════════════════════════════════════════════════
        function fmt(n) {
            if (n === null || n === undefined || isNaN(n)) return '-';
            return Math.round(n).toLocaleString('ko-KR');
        }

        function sleep(ms) {
            return new Promise(r => setTimeout(r, ms));
        }

        // PRD: 타이핑 효과 (LLM 스트리밍)
        async function typeText(element, text, speed = 25) {
            element.classList.add('typing-cursor');
            let i = 0;
            const len = text.length;
            while (i < len) {
                const chunk = text.substring(i, Math.min(i + 3, len));
                element.textContent += chunk;
                i += 3;
                if (i % 9 === 0) await sleep(speed);
            }
            element.classList.remove('typing-cursor');
        }

        // ═══════════════════════════════════════════════════════════════
        //  PRD v2.0 Progress Bar
        // ═══════════════════════════════════════════════════════════════
        function setProgress(percent, stepText) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressStep').textContent = stepText;
            document.getElementById('progressPercent').textContent = percent + '%';
        }

        function updateStepCount(current, total) {
            currentStep = current;
            totalSteps = total;
            document.getElementById('stepCount').textContent = `${current} / ${total} 단계`;
        }

        // ═══════════════════════════════════════════════════════════════
        //  PRD v2.0 Agent Panel Functions
        // ═══════════════════════════════════════════════════════════════
        function clearAgentPanel() {
            document.getElementById('agentPanel').innerHTML = '';
            setProgress(0, '대기 중');
            updateStepCount(0, 0);
        }

        async function addAgentCard(type, content, options = {}) {
            const panel = document.getElementById('agentPanel');
            const card = document.createElement('div');
            card.className = `agent-card ${type} slide-in-left`;
            card.dataset.cardId = Date.now();
            
            let icon, iconClass, title;
            switch(type) {
                case 'data':
                    icon = 'fa-database';
                    iconClass = 'text-blue-400';
                    title = options.title || '데이터 수집';
                    break;
                case 'rule':
                    icon = 'fa-cogs';
                    iconClass = 'text-purple-400';
                    title = options.title || '단가 산출';
                    break;
                case 'search':
                    icon = 'fa-globe';
                    iconClass = 'text-green-400';
                    title = options.title || '웹검색';
                    break;
                case 'llm':
                    icon = 'fa-brain';
                    iconClass = 'text-orange-400';
                    title = options.title || 'AI 분석';
                    break;
                case 'result-good':
                case 'result-normal':
                case 'result-bad':
                    icon = 'fa-flag-checkered';
                    iconClass = type === 'result-good' ? 'text-green-400' : 
                               (type === 'result-bad' ? 'text-red-400' : 'text-yellow-400');
                    title = options.title || '판정 결과';
                    break;
                default:
                    icon = 'fa-info-circle';
                    iconClass = 'text-gray-400';
                    title = options.title || '정보';
            }
            
            const statusHtml = options.loading 
                ? '<span class="spinner"></span>' 
                : (options.badge || '<i class="fas fa-check text-green-400"></i>');
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="text-xs font-semibold flex items-center gap-2">
                        <i class="fas ${icon} ${iconClass} card-icon"></i>
                        ${title}
                    </span>
                    <span class="card-status">${statusHtml}</span>
                </div>
                <div class="card-content text-sm text-gray-300 leading-relaxed" id="content-${card.dataset.cardId}"></div>
            `;
            
            panel.appendChild(card);
            panel.scrollTop = panel.scrollHeight;
            
            const contentEl = card.querySelector('.card-content');
            
            if (options.typing) {
                await typeText(contentEl, content, options.speed || 20);
            } else {
                contentEl.innerHTML = content;
            }
            
            // 로딩 완료 시 스피너 → 체크
            if (options.loading) {
                await sleep(options.delay || 600);
                const status = card.querySelector('.card-status');
                if (status) status.innerHTML = '<i class="fas fa-check text-green-400"></i>';
            }
            
            await sleep(150);
            return card;
        }

        // PRD: 완료된 단계 접기
        function collapseCompleted() {
            const cards = document.querySelectorAll('.agent-card:not(.result-good):not(.result-normal):not(.result-bad)');
            cards.forEach((card, idx) => {
                if (idx < cards.length - 2) {
                    card.classList.toggle('collapsed');
                }
            });
        }

        // ═══════════════════════════════════════════════════════════════
        //  Tab Switching
        // ═══════════════════════════════════════════════════════════════
        function switchTab(tabNum) {
            if (isRunning) return;
            currentTab = tabNum;
            
            // Agent 패널 초기화
            clearAgentPanel();
            
            // Progress bar 초기화
            setProgress(0, '대기 중');
            updateStepCount(0, 0);
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('bg-gray-700/50', 'hover:bg-gray-700');
            });
            const activeBtn = document.querySelector(`[data-tab="${tabNum}"]`);
            activeBtn.classList.add('active');
            activeBtn.classList.remove('bg-gray-700/50', 'hover:bg-gray-700');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab${tabNum}`).classList.remove('hidden');
        }

        // ═══════════════════════════════════════════════════════════════
        //  Demo Mode Entry Point
        // ═══════════════════════════════════════════════════════════════
        async function startDemo() {
            if (isRunning) return;
            isRunning = true;
            
            const btn = document.getElementById('demoBtn');
            btn.innerHTML = '<span class="spinner"></span> <span>분석 중...</span>';
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed');
            
            clearAgentPanel();
            
            try {
                if (currentTab === 1) {
                    await runScreen1Demo();
                } else if (currentTab === 2) {
                    await runScreen2Demo();
                } else if (currentTab === 3) {
                    await runScreen3Demo();
                }
            } catch (err) {
                console.error(err);
                await addAgentCard('result-bad', `❌ 오류 발생: ${err.message}`, { title: '오류' });
            }
            
            btn.innerHTML = '<i class="fas fa-play"></i> <span>분석 실행</span>';
            btn.disabled = false;
            btn.classList.remove('opacity-70', 'cursor-not-allowed');
            isRunning = false;
        }

        // ═══════════════════════════════════════════════════════════════
        //  Screen 1: PR 건 최적 추천 단가 제안 (PRD v2.0)
        // ═══════════════════════════════════════════════════════════════
        async function runScreen1Demo() {
            updateStepCount(0, 5);
            
            // Step 1: 데이터 수집
            setProgress(15, '단가테이블 조회');
            updateStepCount(1, 5);
            
            await addAgentCard('data', '', { loading: true, title: '택입 단가테이블 조회', delay: 700 });
            document.querySelector('.agent-card.data:last-child .card-content').innerHTML = 
                '<div class="mono text-xs">→ 482건 로드 완료 (BODY2, 옵션단가 포함)</div>';
            
            await addAgentCard('data', '', { loading: true, title: '택입 발주실적 조회', delay: 900 });
            document.querySelector('.agent-card.data:last-child .card-content').innerHTML = 
                '<div class="mono text-xs">→ 36,960건 로드 완료 (2.1s)</div>';
            
            // Step 2: PR 데이터 추출
            setProgress(30, 'PR 데이터 추출');
            updateStepCount(2, 5);
            
            await addAgentCard('rule', `
                <div class="space-y-1 text-xs">
                    <div>• BC밸브(VGBARR240A) 대상 (~654건)</div>
                    <div>• 단가테이블 매핑 / 미매핑 분류</div>
                </div>
            `, { title: 'PR 데이터 추출' });
            
            // Step 3: 계약단가 산출
            setProgress(50, '계약단가 산출');
            updateStepCount(3, 5);
            
            await addAgentCard('rule', `
                <div class="space-y-2 text-xs">
                    <div class="flex items-center gap-2">
                        <span class="badge badge-info">본가</span>
                        <span>밸브타입 매핑 → BODY2 기본단가</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="badge badge-info">옵션</span>
                        <span>키워드 추출 → 옵션단가 합산</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="badge badge-info">합계</span>
                        <span>수량 환산 → 개당 계약단가</span>
                    </div>
                </div>
            `, { title: '계약단가 산출 기준' });
            
            // Step 4: 발주실적 매핑
            setProgress(65, '발주실적 조회');
            updateStepCount(4, 5);
            
            await addAgentCard('rule', `
                <div class="space-y-2 text-xs">
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-green-400"></span>
                        <span><b>1순위:</b> 밸브타입 + 자재내역 100% 일치</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-yellow-400"></span>
                        <span><b>2순위:</b> 밸브타입만 일치 → 최근 발주단가</span>
                    </div>
                </div>
            `, { title: '발주실적 기반 예상단가' });
            
            // API 호출
            setProgress(80, '결과 생성');
            updateStepCount(5, 5);
            
            const res = await fetch('/api/screen1/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const data = await res.json();
            
            if (!data.success) throw new Error(data.error || '분석 실패');
            
            // 결과 요약 카드
            const summary = data.summary || {};
            const mappedCount = summary.mapped || data.results.filter(r => r.mapped).length;
            const unmappedCount = summary.unmapped || data.results.length - mappedCount;
            
            const resultType = mappedCount >= unmappedCount * 2 ? 'result-good' : 'result-normal';
            await addAgentCard(resultType, `
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="p-2 rounded bg-white/5">
                        <div class="text-lg font-bold text-white">${data.results.length}</div>
                        <div class="text-xs text-gray-400">전체 PR</div>
                    </div>
                    <div class="p-2 rounded bg-green-500/10">
                        <div class="text-lg font-bold text-green-400">${mappedCount}</div>
                        <div class="text-xs text-gray-400">단가표 매핑</div>
                    </div>
                    <div class="p-2 rounded bg-yellow-500/10">
                        <div class="text-lg font-bold text-yellow-400">${unmappedCount}</div>
                        <div class="text-xs text-gray-400">실적 기준</div>
                    </div>
                </div>
            `, { title: '분석 완료', badge: '<span class="badge badge-good">완료</span>' });
            
            setProgress(100, '완료');
            
            // 결과 테이블 렌더링
            renderScreen1Results(data.results, data.summary);
        }

        function renderScreen1Results(results, summary) {
            document.getElementById('screen1-intro').classList.add('hidden');
            const container = document.getElementById('screen1-results');
            container.classList.remove('hidden');

            let html = `
            <div class="mb-5">
                <h3 class="text-lg font-bold flex items-center gap-2 mb-2">
                    <i class="fas fa-table text-blue-400"></i>
                    PR 건별 단가 분석 결과
                </h3>
                <p class="text-xs text-gray-500">
                    전체 ${summary?.total || results.length}건 (매핑 ${summary?.mapped || '-'}건 / 미매핑 ${summary?.unmapped || '-'}건) | 행을 클릭하면 상세 정보가 펼쳐집니다
                </p>
            </div>
            
            <div class="overflow-x-auto rounded-xl border border-gray-700/50" style="max-height: calc(100vh - 320px);">
                <table class="prd-table">
                    <thead>
                        <tr>
                            <th class="section-header" colspan="5">PR 세부 내역</th>
                            <th class="section-header" colspan="3">계약단가 (본가+옵션)</th>
                            <th class="section-header" colspan="3">최근발주단가 (실적)</th>
                            <th class="section-header">발주×90%</th>
                        </tr>
                        <tr>
                            <th style="width:50px">No</th>
                            <th style="min-width:150px">V/V TYPE</th>
                            <th style="width:70px">V/V NO</th>
                            <th style="width:60px">수량</th>
                            <th style="width:70px">총중량</th>
                            <th style="width:90px">본가</th>
                            <th style="width:80px">옵션</th>
                            <th style="width:100px" class="highlight">합계</th>
                            <th style="width:70px">업체</th>
                            <th style="width:70px">일자</th>
                            <th style="width:100px">금액</th>
                            <th style="width:100px" class="recommend">금액</th>
                        </tr>
                    </thead>
                    <tbody id="screen1-tbody">`;

            for (let i = 0; i < results.length; i++) {
                const r = results[i];
                const mappedBadge = r.mapped 
                    ? '<span class="inline-block w-2 h-2 rounded-full bg-green-400 mr-1"></span>' 
                    : '<span class="inline-block w-2 h-2 rounded-full bg-yellow-400 mr-1"></span>';
                
                // 중량 표시
                const weightDisplay = r.totalWeight 
                    ? `${r.totalWeight.toFixed(3)} TN` 
                    : (r.unitWeight ? `${r.unitWeight} kg` : '-');
                
                html += `
                    <tr onclick="toggleDetail1(${i}, this)" id="row-${i}">
                        <td class="font-semibold text-blue-300">${String(i+1).padStart(3,'0')}</td>
                        <td class="text-left">
                            <div class="flex items-center">
                                ${mappedBadge}
                                <span class="mono text-xs text-blue-300">${r.valveType || '-'}</span>
                            </div>
                            <div class="text-xs text-gray-500 truncate mt-1" style="max-width:140px" title="${r.description}">${r.description || '-'}</div>
                        </td>
                        <td class="mono text-xs">${r.valveNo || '-'}</td>
                        <td class="text-center">${r.quantity} ${r.uom || 'EA'}</td>
                        <td class="text-xs text-gray-400">${weightDisplay}</td>
                        <td class="text-right price ${r.mapped ? '' : 'text-gray-500'}">${fmt(r.body2Price)}</td>
                        <td class="text-right price">${fmt(r.optionPrice)}</td>
                        <td class="text-right price highlight font-semibold">${fmt(r.contractPrice)}</td>
                        <td class="text-xs">${r.recentOrder?.vendor?.substring(0, 4) || '-'}</td>
                        <td class="text-xs text-gray-400">${r.recentOrder?.date?.substring(5) || '-'}</td>
                        <td class="text-right price">${fmt(r.recentPrice)}</td>
                        <td class="text-right price recommend text-yellow-400">${fmt(r.recent90)}</td>
                    </tr>
                    <tr id="detail-${i}" class="hidden">
                        <td colspan="12" class="p-0 bg-transparent">
                            <div class="detail-panel">
                                <div class="grid grid-cols-3 gap-6">
                                    <div>
                                        <h4 class="font-semibold text-blue-400 mb-3 flex items-center gap-2">
                                            <i class="fas fa-info-circle"></i>PR 상세 정보
                                        </h4>
                                        <div class="space-y-2 text-xs text-gray-300">
                                            <div class="flex justify-between"><span class="text-gray-500">V/V TYPE:</span><span class="mono">${r.valveType}</span></div>
                                            <div class="flex justify-between"><span class="text-gray-500">V/V NO:</span><span class="mono">${r.valveNo || '-'}</span></div>
                                            <div class="flex justify-between"><span class="text-gray-500">수량:</span><span>${r.quantity} ${r.uom || 'EA'}</span></div>
                                            <div class="flex justify-between"><span class="text-gray-500">총중량:</span><span>${weightDisplay}</span></div>
                                            <div class="flex justify-between"><span class="text-gray-500">매핑:</span><span class="${r.mapped ? 'text-green-400' : 'text-yellow-400'}">${r.mapped ? '✅ 성공' : '⚠️ 미매핑'}</span></div>
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-purple-400 mb-3 flex items-center gap-2">
                                            <i class="fas fa-cogs"></i>단가 산출 근거
                                        </h4>
                                        <div class="space-y-2 text-xs text-gray-300">
                                            <div class="flex justify-between"><span class="text-gray-500">본가 (BODY2):</span><span class="mono">${r.mapped ? fmt(r.body2Price) + '원' : '미매핑'}</span></div>
                                            <div class="flex justify-between"><span class="text-gray-500">옵션단가:</span><span class="mono">${fmt(r.optionPrice)}원</span></div>
                                            <div class="flex justify-between"><span class="text-gray-500">계약단가 합계:</span><span class="mono font-semibold text-yellow-400">${fmt(r.contractPrice)}원</span></div>
                                            ${r.tableQty ? `<div class="flex justify-between"><span class="text-gray-500">단가표 수량:</span><span>${r.tableQty}개 기준</span></div>` : ''}
                                        </div>
                                    </div>
                                    <div>
                                        <h4 class="font-semibold text-orange-400 mb-3 flex items-center gap-2">
                                            <i class="fas fa-history"></i>발주실적
                                        </h4>
                                        <div class="space-y-2 text-xs text-gray-300">
                                            ${r.recentOrder ? `
                                                <div class="flex justify-between"><span class="text-gray-500">순위:</span><span>${r.recentOrder.rank}</span></div>
                                                <div class="flex justify-between"><span class="text-gray-500">업체:</span><span>${r.recentOrder.vendor}</span></div>
                                                <div class="flex justify-between"><span class="text-gray-500">일자:</span><span>${r.recentOrder.date}</span></div>
                                                <div class="flex justify-between"><span class="text-gray-500">금액:</span><span class="mono">${fmt(r.recentPrice)}원</span></div>
                                                <div class="flex justify-between"><span class="text-gray-500">×90%:</span><span class="mono text-yellow-400">${fmt(r.recent90)}원</span></div>
                                            ` : '<div class="text-gray-500">발주실적 없음</div>'}
                                        </div>
                                    </div>
                                </div>
                                ${r.optionDetails?.length ? `
                                <div class="mt-4 pt-4 border-t border-gray-700">
                                    <span class="text-xs text-gray-400"><i class="fas fa-tags mr-1"></i>옵션 상세: <span class="text-purple-300">${r.optionDetails.join(', ')}</span></span>
                                </div>
                                ` : ''}
                            </div>
                        </td>
                    </tr>`;
            }

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        function toggleDetail1(index, row) {
            const detailRow = document.getElementById(`detail-${index}`);
            const isHidden = detailRow.classList.contains('hidden');
            
            document.querySelectorAll('[id^="detail-"]').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('#screen1-tbody tr').forEach(el => el.classList.remove('expanded'));
            
            if (isHidden) {
                detailRow.classList.remove('hidden');
                row.classList.add('expanded');
            }
        }

        // ═══════════════════════════════════════════════════════════════
        //  Screen 2: 협력사 견적 적정성 검증 (PRD v2.0)
        // ═══════════════════════════════════════════════════════════════
        async function runScreen2Demo() {
            updateStepCount(0, 5);
            
            // Step 1: 데이터 수집
            setProgress(15, '견적 데이터 조회');
            updateStepCount(1, 5);
            
            await addAgentCard('data', '', { loading: true, title: '협력사 견적 조회', delay: 600 });
            document.querySelector('.agent-card.data:last-child .card-content').innerHTML = 
                '<div class="mono text-xs">→ 159건 로드 완료</div>';
            
            // Step 2: 전처리
            setProgress(30, '밸브타입 매핑');
            updateStepCount(2, 5);
            
            await addAgentCard('rule', `
                <div class="space-y-1 text-xs">
                    <div>⚠️ 견적에 밸브타입 없음 → 발주실적에서 매핑 필요</div>
                    <div>• 자재번호 앞 4자리 제거 → mat_core 추출</div>
                    <div>• 실적 딕셔너리에서 Valve Type 매핑</div>
                </div>
            `, { title: '전처리 - 밸브타입 매핑' });
            
            await addAgentCard('data', `
                <div class="flex items-center gap-3">
                    <div class="text-2xl font-bold text-green-400">79%</div>
                    <div class="text-xs text-gray-400">매핑 성공률<br>(126/159건)</div>
                </div>
            `, { title: '매핑 완료' });
            
            // Step 3: 적정성 검증
            setProgress(50, '적정성 판정');
            updateStepCount(3, 5);
            
            await addAgentCard('rule', `
                <div class="space-y-2 text-xs">
                    <div class="flex items-center gap-2">
                        <span class="badge badge-good">✅ 우수</span>
                        <span>발주×90% ≥ 견적가</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="badge badge-normal">🔶 보통</span>
                        <span>발주/계약 ≥ 견적가</span>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="badge badge-bad">❌ 부적절</span>
                        <span>기준 미달</span>
                    </div>
                </div>
            `, { title: '적정성 판정 기준' });
            
            // API 호출
            setProgress(70, '결과 집계');
            updateStepCount(4, 5);
            
            const res = await fetch('/api/screen2/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const data = await res.json();
            
            if (!data.success) throw new Error(data.error || '분석 실패');
            
            // 결과 요약
            const resultType = data.counts.부적절 < data.total * 0.1 ? 'result-good' 
                : (data.counts.부적절 < data.total * 0.2 ? 'result-normal' : 'result-bad');
            
            await addAgentCard(resultType, `
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="p-2 rounded bg-green-500/20">
                        <div class="text-lg font-bold text-green-400">${data.counts.우수}</div>
                        <div class="text-xs text-gray-400">우수</div>
                    </div>
                    <div class="p-2 rounded bg-yellow-500/20">
                        <div class="text-lg font-bold text-yellow-400">${data.counts.보통}</div>
                        <div class="text-xs text-gray-400">보통</div>
                    </div>
                    <div class="p-2 rounded bg-red-500/20">
                        <div class="text-lg font-bold text-red-400">${data.counts.부적절}</div>
                        <div class="text-xs text-gray-400">부적절</div>
                    </div>
                </div>
            `, { title: '적정성 분포', badge: '<span class="badge badge-good">완료</span>' });
            
            // Step 5: LLM 분석
            setProgress(85, '부적절 건 분석');
            updateStepCount(5, 5);
            
            const badItems = data.results.filter(r => r.assessment === '부적절');
            if (badItems.length > 0) {
                await addAgentCard('llm', '', { title: '부적절 건 원인 분석', typing: true });
                const llmCard = document.querySelector('.agent-card.llm:last-child .card-content');
                
                let llmText = `[부적절 ${badItems.length}건 분석]\n`;
                for (const item of badItems.slice(0, 3)) {
                    const gap = item.gapPercent ? `+${item.gapPercent.toFixed(0)}%` : '';
                    llmText += `• ${item.materialNo}: ${fmt(item.quotePrice)}원 vs ${fmt(item.recentPrice)}원 (${gap})\n`;
                }
                llmText += `\n💡 협상 전략: 최근발주×90% 기준 재견적 요청 권장`;
                
                await typeText(llmCard, llmText, 15);
            }
            
            setProgress(100, '완료');
            
            renderScreen2Results(data);
        }

        function renderScreen2Results(data) {
            document.getElementById('screen2-intro').classList.add('hidden');
            const container = document.getElementById('screen2-results');
            container.classList.remove('hidden');

            const goodPct = (data.counts.우수 / data.total * 100).toFixed(1);
            const normalPct = (data.counts.보통 / data.total * 100).toFixed(1);
            const badPct = (data.counts.부적절 / data.total * 100).toFixed(1);

            let html = `
            <!-- 상단: KPI 대시보드 -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="col-span-1">
                    <div class="chart-container h-full flex items-center justify-center">
                        <canvas id="donutChart" height="130"></canvas>
                    </div>
                </div>
                <div class="col-span-3 grid grid-cols-3 gap-4">
                    <div class="kpi-card border-l-4 border-green-500">
                        <div class="kpi-value text-green-400">${data.counts.우수}</div>
                        <div class="text-xs text-gray-400 mt-1">✅ 우수 (${goodPct}%)</div>
                        <div class="text-xs text-green-400/70 mt-2">즉시 발주 추천</div>
                    </div>
                    <div class="kpi-card border-l-4 border-yellow-500">
                        <div class="kpi-value text-yellow-400">${data.counts.보통}</div>
                        <div class="text-xs text-gray-400 mt-1">🔶 보통 (${normalPct}%)</div>
                        <div class="text-xs text-yellow-400/70 mt-2">구매 가능</div>
                    </div>
                    <div class="kpi-card border-l-4 border-red-500">
                        <div class="kpi-value text-red-400">${data.counts.부적절}</div>
                        <div class="text-xs text-gray-400 mt-1">❌ 부적절 (${badPct}%)</div>
                        <div class="text-xs text-red-400/70 mt-2">재협상 필요</div>
                    </div>
                </div>
            </div>

            <!-- 중단: 견적 테이블 -->
            <div class="overflow-x-auto rounded-xl border border-gray-700/50 mb-6" style="max-height: 300px;">
                <table class="prd-table">
                    <thead>
                        <tr>
                            <th style="min-width:160px">자재번호/내역</th>
                            <th style="width:100px">견적가</th>
                            <th style="width:100px">최근발주</th>
                            <th style="width:100px">발주×90%</th>
                            <th style="width:100px">계약단가</th>
                            <th style="width:80px">초과율</th>
                            <th style="width:90px">판정</th>
                        </tr>
                    </thead>
                    <tbody>`;

            for (const r of data.results.slice(0, 30)) {
                const badgeClass = r.assessment === '우수' ? 'badge-good' 
                    : r.assessment === '부적절' ? 'badge-bad' : 'badge-normal';
                const gapStr = r.gapPercent !== null ? `${r.gapPercent > 0 ? '+' : ''}${r.gapPercent.toFixed(0)}%` : '-';
                const gapColor = r.gapPercent > 10 ? 'text-red-400 font-semibold' : (r.gapPercent < -5 ? 'text-green-400' : '');

                html += `
                    <tr>
                        <td class="text-left">
                            <div class="mono text-xs text-blue-300">${r.materialNo}</div>
                            <div class="text-xs text-gray-500 truncate" style="max-width:150px">${r.description}</div>
                        </td>
                        <td class="text-right price">${fmt(r.quotePrice)}</td>
                        <td class="text-right price">${fmt(r.recentPrice)}</td>
                        <td class="text-right price text-yellow-400">${fmt(r.recent90)}</td>
                        <td class="text-right price">${fmt(r.contractPrice)}</td>
                        <td class="${gapColor}">${gapStr}</td>
                        <td><span class="badge ${badgeClass}">${r.assessmentLabel}</span></td>
                    </tr>`;
            }

            html += `</tbody></table></div>`;
            
            // 부적절 건 상세
            const badItems = data.results.filter(r => r.assessment === '부적절');
            if (badItems.length > 0) {
                html += `
                <div class="bg-gradient-to-r from-red-500/10 to-red-500/5 border border-red-500/30 rounded-xl p-5">
                    <h4 class="font-semibold text-red-400 mb-4 flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle"></i>
                        부적절 건 집중 분석 (${badItems.length}건)
                    </h4>
                    <div class="space-y-3">
                        ${badItems.slice(0, 5).map(item => {
                            const gap = item.gapPercent ? `+${item.gapPercent.toFixed(0)}%` : '';
                            return `
                            <div class="flex items-center justify-between p-3 rounded-lg bg-red-500/10">
                                <div>
                                    <span class="mono text-xs text-red-300">${item.materialNo}</span>
                                    <span class="text-xs text-gray-500 ml-2">${item.description?.substring(0, 30)}...</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs">견적 <span class="mono text-white">${fmt(item.quotePrice)}</span></span>
                                    <span class="text-xs text-gray-500 mx-2">vs</span>
                                    <span class="text-xs">발주 <span class="mono text-white">${fmt(item.recentPrice)}</span></span>
                                    <span class="badge badge-bad ml-2">${gap}</span>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    <div class="mt-4 pt-4 border-t border-red-500/20 text-sm text-gray-400">
                        💡 <span class="text-yellow-400">협상 전략:</span> 최근발주×90% 기준 재견적 요청 권장
                    </div>
                </div>`;
            }
            
            container.innerHTML = html;
            
            // 도넛 차트
            setTimeout(() => {
                if (chartInstances.donut) chartInstances.donut.destroy();
                const ctx = document.getElementById('donutChart')?.getContext('2d');
                if (ctx) {
                    chartInstances.donut = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['우수', '보통', '부적절'],
                            datasets: [{
                                data: [data.counts.우수, data.counts.보통, data.counts.부적절],
                                backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(239, 68, 68, 0.8)'],
                                borderColor: ['#10b981', '#f59e0b', '#ef4444'],
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            cutout: '70%'
                        }
                    });
                }
            }, 100);
        }

        // ═══════════════════════════════════════════════════════════════
        //  Screen 3: 시황 분석 (PRD v2.0)
        // ═══════════════════════════════════════════════════════════════
        async function runScreen3Demo() {
            updateStepCount(0, 5);
            
            // Step 1: 내부 데이터 요약
            setProgress(15, 'BC밸브 데이터 필터링');
            updateStepCount(1, 5);
            
            await addAgentCard('data', '', { loading: true, title: 'BC밸브 (VGBARR240AT) 필터링', delay: 800 });
            document.querySelector('.agent-card.data:last-child .card-content').innerHTML = `
                <div class="space-y-1 text-xs">
                    <div>• LOCK 제외, TR 끝자리 필터</div>
                    <div>• 결과: <span class="text-green-400 font-semibold">431건</span> 추출</div>
                </div>
            `;
            
            // Step 2: 웹검색 (LME 시황)
            setProgress(35, 'LME 시황 수집');
            updateStepCount(2, 5);
            
            await addAgentCard('search', '', { title: 'LME 시황 수집', typing: true });
            const searchCard = document.querySelector('.agent-card.search:last-child .card-content');
            await typeText(searchCard, '🔍 Query: "LME copper tin price 2025 monthly average USD"', 30);
            await sleep(400);
            
            await addAgentCard('search', `
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-2 rounded bg-orange-500/10 text-center">
                        <div class="text-lg font-bold text-orange-400">+31%</div>
                        <div class="text-xs text-gray-400">Cu (구리)</div>
                        <div class="text-xs text-gray-500">8,978 → 11,791</div>
                    </div>
                    <div class="p-2 rounded bg-yellow-500/10 text-center">
                        <div class="text-lg font-bold text-yellow-400">+40%</div>
                        <div class="text-xs text-gray-400">Sn (주석)</div>
                        <div class="text-xs text-gray-500">26,339 → 36,876</div>
                    </div>
                </div>
                <div class="text-xs text-gray-500 mt-2">* Fallback: LME_CuSn_Monthly_2025.xlsx</div>
            `, { title: 'LME 시황 데이터' });
            
            // Step 3: 트렌드 비교
            setProgress(55, '트렌드 비교');
            updateStepCount(3, 5);
            
            await addAgentCard('rule', `
                <div class="space-y-1 text-xs">
                    <div>✅ 4개월 시차 적용 (원재료 → 업체단가)</div>
                    <div>✅ 지수 = (해당월 값 ÷ 1월 값) × 100</div>
                    <div>✅ 100 이상 = 상승, 100 이하 = 하락</div>
                    <div>✅ 원재료 비중 80% 적용</div>
                    <div class="text-gray-400 mt-1">예: 1월 원재료 → 5월 업체 단가</div>
                </div>
            `, { title: '트렌드 비교 (4개월 시차)' });
            
            // API 호출
            setProgress(70, '적정성 판정');
            updateStepCount(4, 5);
            
            const res = await fetch('/api/screen3/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({})
            });
            const data = await res.json();
            
            if (!data.success) throw new Error(data.error || '분석 실패');
            
            const ac = data.assessmentCounts;
            const resultType = ac.Good >= ac.Bad ? 'result-good' : (ac.Bad > ac.Good * 2 ? 'result-bad' : 'result-normal');
            
            await addAgentCard(resultType, `
                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="p-2 rounded bg-green-500/20">
                        <div class="text-lg font-bold text-green-400">${ac.Good}</div>
                        <div class="text-xs text-gray-400">Good</div>
                    </div>
                    <div class="p-2 rounded bg-yellow-500/20">
                        <div class="text-lg font-bold text-yellow-400">${ac.Normal}</div>
                        <div class="text-xs text-gray-400">Normal</div>
                    </div>
                    <div class="p-2 rounded bg-red-500/20">
                        <div class="text-lg font-bold text-red-400">${ac.Bad}</div>
                        <div class="text-xs text-gray-400">Bad</div>
                    </div>
                </div>
            `, { title: '월별 적정성 판정', badge: '<span class="badge badge-good">완료</span>' });
            
            // Step 5: LLM 종합 분석
            setProgress(85, '종합 분석');
            updateStepCount(5, 5);
            
            await addAgentCard('llm', '', { title: '종합 분석', typing: true });
            const llmCard = document.querySelector('.agent-card.llm:last-child .card-content');
            
            const badMonths = Object.entries(data.assessments)
                .filter(([_, v]) => v.label === 'Bad')
                .map(([m, _]) => m + '월');
            
            const llmText = `[업체 행동 패턴]
원광밸브: 시황 +${data.summary.cuYearChange}%(Cu) 상승에도 단가 안정. 보수적 가격 전략.

[리스크]
Bad 판정 ${ac.Bad}개월 (${badMonths.join(', ') || '없음'}) - 시황 하락분 미반영.

[구매 전략]
• 단기: Bad 월 소급 인하 3~5% 요청
• 중기: LME 연동 계약 조항 도입
• 장기: 복수 업체 포트폴리오 확대`;
            
            await typeText(llmCard, llmText, 12);
            
            setProgress(100, '완료');
            
            renderScreen3Results(data);
        }

        function renderScreen3Results(data) {
            document.getElementById('screen3-intro').classList.add('hidden');
            const container = document.getElementById('screen3-results');
            container.classList.remove('hidden');

            const ac = data.assessmentCounts;
            const badMonths = Object.entries(data.assessments)
                .filter(([_, v]) => v.label === 'Bad')
                .map(([m, _]) => m + '월');

            let html = `
            <!-- KPI 카드 -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="kpi-card">
                    <div class="kpi-value text-orange-400">+${data.summary.cuYearChange}%</div>
                    <div class="text-xs text-gray-400 mt-1">Cu (구리) 연간</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value text-yellow-400">+${data.summary.snYearChange}%</div>
                    <div class="text-xs text-gray-400 mt-1">Sn (주석) 연간</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value text-blue-400">${data.summary.totalOrders}</div>
                    <div class="text-xs text-gray-400 mt-1">분석 건수</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value ${ac.Good >= ac.Bad ? 'text-green-400' : 'text-red-400'}">
                        ${ac.Good >= ac.Bad ? '양호' : '주의'}
                    </div>
                    <div class="text-xs text-gray-400 mt-1">전체 판정</div>
                </div>
            </div>

            <!-- 핵심 차트: 시황 vs 발주 트렌드 -->
            <div class="chart-container mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="font-semibold text-sm flex items-center gap-2">
                        <i class="fas fa-chart-line text-blue-400"></i>
                        원재료 시황 vs 업체 단가 변화율 (4개월 시차)
                    </h4>
                    <span class="text-xs text-gray-500">지수: 1월 = 100 기준</span>
                </div>
                <canvas id="trendChart" height="200"></canvas>
                <div class="mt-3 p-3 bg-gray-800/50 rounded-lg text-xs text-gray-400">
                    <div class="font-semibold text-gray-300 mb-2">📐 지수 계산식</div>
                    <div class="font-mono">지수 = (해당월 값 ÷ 1월 값) × 100</div>
                    <div class="mt-2 text-gray-500">
                        예: 2월 원재료 12,035원 ÷ 1월 11,455원 × 100 = <span class="text-orange-400">105.1</span> (+5.1% 상승)
                    </div>
                </div>
            </div>

            <!-- 월별 적정성 타임라인 -->
            <div class="chart-container mb-6">
                <h4 class="font-semibold text-sm mb-4 flex items-center gap-2">
                    <i class="fas fa-calendar-alt text-purple-400"></i>
                    월별 적정성 타임라인 (4개월 시차 기준)
                </h4>
                <div class="flex justify-between items-center px-4">
                    ${Object.entries(data.assessments).map(([m, v]) => {
                        const dotClass = v.label.toLowerCase();
                        const lagInfo = v.lagMonth ? `(${v.lagMonth}월 시황 기준)` : '';
                        return `
                        <div class="text-center group">
                            <div class="timeline-dot ${dotClass} mb-2 mx-auto" title="${m}월: ${v.label} ${lagInfo}\n시황 ${v.marketChange > 0 ? '+' : ''}${v.marketChange}% → 단가 ${v.priceChange > 0 ? '+' : ''}${v.priceChange}%">
                                ${m}
                            </div>
                            <div class="text-xs text-gray-500">${v.label}</div>
                        </div>`;
                    }).join('')}
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700/50 flex justify-center gap-8 text-sm">
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-green-500"></span> Good: ${ac.Good}</span>
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-yellow-500"></span> Normal: ${ac.Normal}</span>
                    <span class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-red-500"></span> Bad: ${ac.Bad}</span>
                </div>
            </div>

            <!-- Executive Summary -->
            <div class="bg-gradient-to-r from-orange-500/10 via-yellow-500/5 to-orange-500/10 border border-orange-500/30 rounded-xl p-5">
                <h4 class="font-semibold text-orange-400 mb-4 flex items-center gap-2">
                    <i class="fas fa-brain"></i>
                    Executive Summary
                </h4>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <h5 class="text-xs text-gray-400 mb-3 font-semibold">💡 핵심 인사이트</h5>
                        <div class="space-y-2 text-sm text-gray-300">
                            <p>• 시황 <span class="text-orange-400">+${data.summary.cuYearChange}%</span>(Cu) / <span class="text-yellow-400">+${data.summary.snYearChange}%</span>(Sn) 상승</p>
                            <p>• <span class="text-green-400">Good ${ac.Good}개월</span> → 시황 대비 유리한 구매 구조</p>
                            <p>• 괴리 영역 = 구매 측 협상 레버리지</p>
                            ${badMonths.length > 0 ? `<p>• <span class="text-red-400">Bad: ${badMonths.join(', ')}</span> → 인하 미반영</p>` : ''}
                        </div>
                    </div>
                    <div>
                        <h5 class="text-xs text-gray-400 mb-3 font-semibold">🎯 구매 전략</h5>
                        <div class="space-y-2 text-sm text-gray-300">
                            <p>• <span class="text-green-400 font-semibold">단기:</span> Bad 월 소급 인하 3~5% 요청</p>
                            <p>• <span class="text-yellow-400 font-semibold">중기:</span> LME 연동 계약 조항 도입 (4개월 시차)</p>
                            <p>• <span class="text-blue-400 font-semibold">장기:</span> 복수 업체 포트폴리오 확대</p>
                        </div>
                    </div>
                </div>
            </div>`;

            container.innerHTML = html;
            
            // 트렌드 차트
            setTimeout(() => drawTrendChart(data), 100);
        }

        function drawTrendChart(data) {
            if (chartInstances.trend) chartInstances.trend.destroy();
            
            const ctx = document.getElementById('trendChart')?.getContext('2d');
            if (!ctx) return;

            const months = data.trendData.map(d => d.monthLabel);
            
            // 지수 데이터 사용 (1월 = 100 기준)
            const cuSnIndex = data.trendData.map(d => d.cuSnIndex);
            const mainVendorIndex = data.trendData.map(d => d.mainVendorIndex);
            
            // 4개월 시차 적용된 원재료 지수 (5월부터 표시)
            const laggedCuSnIndex = data.trendData.map((d, i) => {
                const lagIndex = i - 4;
                if (lagIndex >= 0 && data.trendData[lagIndex]) {
                    return data.trendData[lagIndex].cuSnIndex;
                }
                return null;
            });

            chartInstances.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: '원재료 지수 (Cu+Sn)',
                            data: cuSnIndex,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.15)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 8,
                        },
                        {
                            label: '4개월 전 원재료 (시차)',
                            data: laggedCuSnIndex,
                            borderColor: '#f59e0b',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#f59e0b',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 1,
                            spanGaps: false,
                        },
                        {
                            label: data.summary.mainVendor ? data.summary.mainVendor.substring(0, 6) + ' 지수' : '업체 지수',
                            data: mainVendorIndex,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointBackgroundColor: '#3b82f6',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointHoverRadius: 8,
                            spanGaps: true,
                        },
                        {
                            label: '기준선 (100)',
                            data: Array(12).fill(100),
                            borderColor: 'rgba(255,255,255,0.3)',
                            borderWidth: 2,
                            borderDash: [3, 3],
                            pointRadius: 0,
                            fill: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { 
                            labels: { 
                                color: '#94a3b8', 
                                font: { size: 11, weight: '500' },
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 14,
                            cornerRadius: 8,
                            callbacks: {
                                label: ctx => {
                                    const val = ctx.raw;
                                    if (val === null || val === undefined) return null;
                                    if (ctx.dataset.label === '기준선 (100)') return null;
                                    const change = val - 100;
                                    const sign = change >= 0 ? '+' : '';
                                    return `  ${ctx.dataset.label}: ${val.toFixed(1)} (${sign}${change.toFixed(1)}%)`;
                                },
                                afterBody: (items) => {
                                    const idx = items[0]?.dataIndex;
                                    if (idx !== undefined && idx >= 4) {
                                        const lagMonth = idx - 3;
                                        return [`  📌 비교: ${lagMonth}월 원재료 → ${idx + 1}월 단가`];
                                    }
                                    return [];
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(255,255,255,0.05)' }, 
                            ticks: { color: '#64748b', font: { size: 11 } } 
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            min: 70,
                            max: 130,
                            ticks: { 
                                color: '#94a3b8', 
                                font: { size: 10 },
                                stepSize: 10,
                                callback: val => val
                            },
                            title: {
                                display: true,
                                text: '지수 (1월 = 100)',
                                color: '#94a3b8',
                                font: { size: 11, weight: 'bold' }
                            }
                        }
                        }
                    }
                }
            });
        }

        // ═══════════════════════════════════════════════════════════════
        //  Initialize
        // ═══════════════════════════════════════════════════════════════
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const res = await fetch('/api/health');
                const data = await res.json();
                if (data.status === 'ok') {
                    const d = data.data;
                    document.getElementById('apiStatus').innerHTML = `
                        <span class="w-2 h-2 rounded-full bg-green-400"></span>
                        <span>Python Flask | ${d.priceTable}건, ${d.orders}건</span>
                    `;
                    document.getElementById('apiStatus').className = 
                        'px-4 py-2 bg-green-500/20 text-green-400 rounded-full text-xs font-medium flex items-center gap-2';
                }
            } catch {
                document.getElementById('apiStatus').innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    <span>연결 실패</span>
                `;
                document.getElementById('apiStatus').className = 
                    'px-4 py-2 bg-red-500/20 text-red-400 rounded-full text-xs font-medium flex items-center gap-2';
            }
        });
    </script>
</body>
</html>
